---
import Layout from "../layouts/Layout.astro";
---
<Layout title="StegLLM">
  <div class="shadow p-4 flex justify-between items-center">
    <div class="flex-1 gap-2">
      <button class="btn btn-soft btn-accent btn-sm" id="import"></button>
      <button class="btn btn-soft btn-accent btn-sm" id="export"></button>
      <button class="btn btn-soft btn-warning btn-sm" id="generateKeyPair"></button>
    </div>
    <div class="flex gap-2 items-center">
      <div class="dropdown dropdown-center">
        <div tabindex="0" role="button" class="btn btn-ghost p-2" id="lang">
          <svg class="size-6" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 0 1-3.827-5.802"/></svg>
        </div>
        <ul tabindex="0" class="dropdown-content bg-base-200 z-1 py-1 w-20">
          <li>
            <input type="radio" name="lang-dropdown" class="btn btn-sm btn-block btn-ghost" aria-label="ÁÆÄ‰Ωì‰∏≠Êñá" value="zh-Hans" />
          </li>
          <li>
            <input type="radio" name="lang-dropdown" class="btn btn-sm btn-block btn-ghost" aria-label="Ê≠£È´î‰∏≠Êñá" value="zh-Hant" />
          </li>
          <li>
            <input type="radio" name="lang-dropdown" class="btn btn-sm btn-block btn-ghost" aria-label="English" value="en" />
          </li>
        </ul>
      </div>
      <div class="dropdown dropdown-center">
        <div tabindex="0" role="button" class="btn btn-ghost p-2" id="theme">
          <svg class="size-6" fill="currentColor" viewBox="0 0 16 16"><path d="M12.433 10.07C14.133 10.585 16 11.15 16 8a8 8 0 1 0-8 8c1.996 0 1.826-1.504 1.649-3.08-.124-1.101-.252-2.237.351-2.92.465-.527 1.42-.237 2.433.07M8 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m4.5 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3M5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/></svg>
        </div>
        <ul tabindex="0" class="dropdown-content bg-base-200 z-1 py-1">
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="üåù" value="default" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="üåö" value="dark" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="üå∏" value="valentine" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="üìú" value="retro" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="‚òï" value="coffee" />
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="flex-grow py-6 container mx-auto max-w-6xl">
    <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6">
      <div class="shadow rounded-lg p-6 flex flex-col gap-6">
        <textarea class="textarea textarea-info w-full h-120 bg-base-200 rounded-lg resize-none" id="secret"></textarea>
        <fieldset class="fieldset">
          <div class="tooltip" id="tooltip">
            <legend class="fieldset-legend" id="publicKeyTitle"></legend>
          </div>
          <input type="file" class="file-input file-input-success" id="publicKey" />
        </fieldset>
        <div class="tooltip" id="tooltip2">
          <fieldset class="fieldset">
            <label class="fieldset-label">
              <input type="checkbox" class="toggle toggle-info" id="insertion" />
              <span id="insertionText"></span>
            </label>
          </fieldset>
        </div>
      </div>
      <div class="flex flex-col items-center justify-center gap-8">
        <div class="radial-progress text-primary hidden" style="--value:0;--size:4rem" aria-valuenow="0" role="progressbar" id="progress"></div>
        <div class="tooltip invisible" id="tooltip3">
          <button class="btn btn-primary btn-circle btn-xl visible" id="hide">
            <svg class="size-6" viewBox="0 0 24 24"><path fill="currentColor" d="M10.5 15h3l-.575-3.225q.5-.25.788-.725T14 10q0-.825-.587-1.412T12 8t-1.412.588T10 10q0 .575.288 1.05t.787.725zm1.5 7q-3.475-.875-5.738-3.988T4 11.1V5l8-3l8 3v6.1q0 3.8-2.262 6.913T12 22"></path></svg>
          </button>
        </div>
        <button class="btn btn-secondary btn-circle btn-xl" id="extract">
          <svg class="size-6" viewBox="0 0 24 24"><path fill="currentColor" d="M18 1c-2.76 0-5 2.24-5 5v2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12c1.11 0 2-.89 2-2V10a2 2 0 0 0-2-2h-1V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2h2V6c0-2.76-2.24-5-5-5m-8 12a2 2 0 0 1 2 2c0 1.11-.89 2-2 2a2 2 0 1 1 0-4"></path></svg>
        </button>
      </div>
      <div class="shadow rounded-lg p-6 flex flex-col gap-6">
        <textarea class="textarea textarea-info w-full h-120 bg-base-200 rounded-lg resize-none" id="coverText"></textarea>
        <fieldset class="fieldset">
          <legend class="fieldset-legend" id="privateKeyTitle"></legend>
          <input type="file" class="file-input file-input-warning" id="privateKey" />
        </fieldset>
      </div>
    </div>
  </div>
  <div class="pl-6 mb-10 container mx-auto max-w-6xl">
    <div class="flex flex-row gap-4 items-center">
      <textarea class="textarea textarea-info w-full h-24 bg-base-200 rounded-lg resize-none" id="prompt"></textarea>
      <div class="flex flex-col">
        <button class="btn btn-ghost" id="up">‚ñ≤</button>
        <button class="btn btn-ghost" id="down">‚ñº</button>
      </div>
      <button class="btn btn-info" id="save"></button>
    </div>
  </div>
  <script>
    import el, { setAllButtonTypesToButton, get, save, saveList, runIfMatch, generateKeyPair, exportLocalStorage, importLocalStorage, initDaisyThemeController, unishoxCompress, readTextFile, eccEncryptToUint8Array, eccDecryptToUint8Array, shuffle, toBinary, toBytes, findSublistIndex, unishoxDecompress, tokenize, detokenize, stringToUnicode, exportFile, check } from "../utils/commonUtils";
    import xxhash from "xxhash-wasm"; //hash-wasm‰∏çÊèê‰æõËøîÂõûintÁ±ªÂûãÁöÑÊé•Âè£
    const { h32 } = await xxhash();
    function confirm(msg = null, title = null) {
      if (title) el.confirmTitle.textContent = title;
      el.confirmMsg.textContent = msg;
      el.confirm.showModal();
    }
    function alert(msg = null, title = null) {
      el.alertTitle.textContent = title;
      el.alertMsg.textContent = msg;
      el.alert.showModal();
    }
    setAllButtonTypesToButton();
    const themeButtons = document.querySelectorAll(`input[name="theme-dropdown"]`);
    function assignStrs(strs) {
      [el.import.textContent, el.export.textContent, el.generateKeyPair.textContent, el.publicKeyTitle.textContent, el.privateKeyTitle.textContent, el.publicKey.ariaLabel, el.privateKey.ariaLabel, el.secret.placeholder, el.coverText.placeholder, el.prompt.placeholder, el.ok.textContent, el.lang.ariaLabel, el.theme.ariaLabel, el.hide.ariaLabel, el.extract.ariaLabel, el.save.textContent, el.progress.ariaLabel, el.insertionText.textContent] = strs;
    }
    function setLang() {
      document.documentElement.lang=get("lang","zh-Hans");
      runIfMatch(
        "lang",
        "zh-Hans",
        {
          "zh-Hans": ["ÂØºÂÖ•ÈÖçÁΩÆ", "ÂØºÂá∫ÈÖçÁΩÆ", "ÁîüÊàêÂØÜÈí•", "ËæìÂÖ•Êé•Êî∂ÊñπÁöÑÂÖ¨Èí•ÔºàÂèØÈÄâÔºâ", "ËæìÂÖ•‰Ω†ÁöÑÁßÅÈí•ÔºàÂèØÈÄâÔºâ", "ËæìÂÖ•Êé•Êî∂ÊñπÁöÑÂÖ¨Èí•ÔºàÂèØÈÄâÔºâ", "ËæìÂÖ•‰Ω†ÁöÑÁßÅÈí•ÔºàÂèØÈÄâÔºâ", "ËØ∑ËæìÂÖ•ÈúÄË¶ÅÂä†ÂØÜÁöÑ‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•ÈúÄË¶ÅËß£ÂØÜÁöÑÊé©È•∞ÊñáÊú¨", `ËØ∑ËæìÂÖ•‰ªªÂä°ÊèêÁ§∫Ôºå‰æãÂ¶ÇÔºö"Áª≠ÂÜô‰∏ÄÊÆµÊï£ÊñáÔºö"\nÁÇπÂáªÂè≥‰æßÁöÑÊåâÈíÆÂèØ‰ª•‰øùÂ≠òÂΩìÂâç‰ªªÂä°ÊèêÁ§∫`, "Á°ÆÂÆö", "ËØ≠Ë®Ä", "‰∏ªÈ¢ò", "ÈöêÂÜô", "ÊèêÂèñ", "‰øùÂ≠ò", "ËøõÂ∫¶Êù°", "ÊîØÊåÅÂâçÂêéÊèíÂÖ•"],
          "zh-Hant": ["Â∞éÂÖ•ÈÖçÁΩÆ", "Â∞éÂá∫ÈÖçÁΩÆ", "ÁîüÊàêÂØÜÈë∞", "Ëº∏ÂÖ•Êé•Êî∂ÊñπÁöÑÂÖ¨Èë∞ÔºàÂèØÈÅ∏Ôºâ", "Ëº∏ÂÖ•‰Ω†ÁöÑÁßÅÈë∞ÔºàÂèØÈÅ∏Ôºâ", "Ëº∏ÂÖ•Êé•Êî∂ÊñπÁöÑÂÖ¨Èë∞ÔºàÂèØÈÅ∏Ôºâ", "Ëº∏ÂÖ•‰Ω†ÁöÑÁßÅÈë∞ÔºàÂèØÈÅ∏Ôºâ", "Ë´ãËº∏ÂÖ•ÈúÄË¶ÅÂä†ÂØÜÁöÑ‰ø°ÊÅØ", "Ë´ãËº∏ÂÖ•ÈúÄË¶ÅËß£ÂØÜÁöÑÊé©È£æÊñáÊú¨", "Ë´ãËº∏ÂÖ•‰ªªÂãôÊèêÁ§∫Ôºå‰æãÂ¶ÇÔºö„ÄåÁ∫åÂØ´‰∏ÄÊÆµÊï£ÊñáÔºö„Äç\nÈªûÊìäÂè≥ÂÅ¥ÁöÑÊåâÈàïÂèØ‰ª•‰øùÂ≠òÁï∂Ââç‰ªªÂãôÊèêÁ§∫", "Á¢∫ÂÆö", "Ë™ûË®Ä", "‰∏ªÈ°å", "Èö±ÂØ´", "ÊèêÂèñ", "‰øùÂ≠ò", "ÈÄ≤Â∫¶Ê¢ù", "ÊîØÊåÅÂâçÂæåÊèíÂÖ•"],
          "en": ["Import Configuration", "Export Configuration", "Generate Key", "Enter Recipient's Public Key (Optional)", "Enter Your Private Key (Optional)", "Enter Recipient's Public Key (Optional)", "Enter Your Private Key (Optional)", "Please Enter the Information to Encrypt", "Please Enter the Masked Text to Decrypt", 'Please Enter the Task Prompt, e.g., "Continue Writing an Essay: "\nClick the Button on the Right to Save the Current Task Prompt', "Confirm", "Language", "Theme", "Steganography", "Extract", "Save", "Progress Bar", "Support Insertion Before and After"],
        },
        (strs) => {
          assignStrs(strs);
        }
      );
      el.tooltip.setAttribute("data-tip", dynamicContent("Âç≥‰ΩøÈöêÂÜôÊö¥Èú≤Ôºå‰πüËÉΩÁ°Æ‰øùÂéüÂßã‰ø°ÊÅØ‰∏ç‰ºöË¢´Á†¥Ëß£", "Âç≥‰ΩøÈö±ÂØ´Êö¥Èú≤Ôºå‰πüËÉΩÁ¢∫‰øùÂéüÂßã‰ø°ÊÅØ‰∏çÊúÉË¢´Á†¥Ëß£", "Even if the Steganography is Exposed, It Ensures the Original Information Cannot Be Cracked"));
      el.tooltip2.setAttribute("data-tip", dynamicContent("ÁîüÊàêÁöÑÊé©È•∞ÊñáÊú¨ÂµåÂÖ•Âà∞‰ªªÊÑèÊñáÊú¨Âêé‰ªçËÉΩÂáÜÁ°ÆËß£ÂØÜÔºåÁï•ÂæÆÂ¢ûÂä†ÈöêÂÜôÊö¥Èú≤ÁöÑÈ£éÈô©", "ÁîüÊàêÁöÑÊé©È£æÊñáÊú¨ÂµåÂÖ•Âà∞‰ªªÊÑèÊñáÊú¨Âæå‰ªçËÉΩÊ∫ñÁ¢∫Ëß£ÂØÜÔºåÁï•ÂæÆÂ¢ûÂä†Èö±ÂØ´Êö¥Èú≤ÁöÑÈ¢®Èö™", "The generated cover text can still be accurately decrypted after being embedded into any text, slightly increasing the risk of steganographic exposure"));
      el.tooltip3.setAttribute("data-tip", dynamicContent("ÂÜçÊ¨°ÁÇπÂáª‰ª•ÂÅúÊ≠¢ÈöêÂÜô", "ÂÜçÊ¨°ÈªûÊìä‰ª•ÂÅúÊ≠¢Èö±ÂØ´", "Click again to stop steganography"));
    }
    function dynamicContent(...strs) {
      return runIfMatch(
        "lang",
        "zh-Hans",
        {
          "zh-Hans": strs[0],
          "zh-Hant": strs[1],
          "en": strs[2],
        },
        (value) => {
          return value;
        }
      );
    }
    function setTheme() {
      const theme = get("theme", "default");
      for (const button of themeButtons) {
        if (button.value === theme) {
          button.checked = true;
          return;
        }
      }
      save("theme", "default");
    }
    function setInsertion() {
      el.insertion.checked = get("insertion", true);
    }
    const langButtons = document.querySelectorAll(`input[name="lang-dropdown"]`);
    langButtons.forEach((button) => {
      button.addEventListener("change", function (event) {
        if (event.target.checked) {
          save("lang", event.target.value);
          setLang();
        }
      });
    });
    el.insertion.addEventListener("change", function (event) {
      save("insertion", event.target.checked);
    });
    el.generateKeyPair.onclick = async () => {
      await generateKeyPair();
      alert(dynamicContent(`Ë´ãÂÆâÂÖ®Âú∞‰øùÂ≠ò‰Ω†ÁöÑÁßÅÈí•ÔºåÂπ∂ÊèêÂâçÂíåÊé•Êî∂Êñπ‰∫§Êç¢ÂÖ¨Èí•`, `Ë´ãÂÆâÂÖ®Âú∞‰øùÂ≠ò‰Ω†ÁöÑÁßÅÈë∞Ôºå‰∏¶ÊèêÂâçËàáÊé•Êî∂Êñπ‰∫§ÊèõÂÖ¨Èë∞`, `Please securely save your private key and exchange public keys with the recipient in advance`), dynamicContent("ÊàêÂäüÔºÅ", "ÊàêÂäüÔºÅ", "Success!"));
    };
    el.export.onclick = () => {
      exportLocalStorage();
    };
    el.import.onclick = async () => {
      await importLocalStorage();
      initConfig();
    };
    let prompts;
    let i;
    el.up.onclick = () => {
      i = (i + 1) % prompts.length;
      save("promptIndex", i);
      el.prompt.value = prompts[i];
    };
    el.down.onclick = () => {
      i = (i - 1 + prompts.length) % prompts.length;
      save("promptIndex", i);
      el.prompt.value = prompts[i];
    };
    el.save.onclick = () => {
      if (el.prompt.value) {
        saveList("prompts", el.prompt.value);
        prompts = get("prompts", [""]);
        i = prompts.length - 1;
        save("promptIndex", i);
        alert("", dynamicContent(`‰øùÂ≠òÊàêÂäüÔºÅ`, `ÂÑ≤Â≠òÊàêÂäüÔºÅ`, `Saved successfully!`));
      } else {
        saveList("prompts", null, i);
        prompts = get("prompts", [""]);
        i = prompts.length - 1;
        el.prompt.value = prompts[i];
        save("promptIndex", i);
        alert("", dynamicContent(`Âà†Èô§ÊàêÂäüÔºÅ`, `Âà™Èô§ÊàêÂäüÔºÅ`, `Deleted successfully!`));
      }
    };
    function initConfig() {
      setTheme();
      setInsertion();
      prompts = get("prompts", [""]);
      i = get("promptIndex", prompts.length - 1);
      el.prompt.value = prompts[i];
      if (window.location.hostname !== "127.0.0.1") {
        el.hide.classList.add("btn-disabled");
        el.save.classList.add("btn-disabled");
        el.up.classList.add("btn-disabled");
        el.down.classList.add("btn-disabled");
        el.publicKey.disabled = true;
        el.insertion.disabled = true;
        el.prompt.disabled = true;
      }
    }
    setLang();
    initDaisyThemeController();
    initConfig();
    function getWeight(code) {
      //scoreÂÄºË∂äÂ∞èÔºåÂ≠óÁ¨¶Ë¢´‰øùÁïôÁöÑÊ¶ÇÁéáË∂äÈ´ò„ÄÇ
      //Èõ∂ÂÆΩÂ≠óÁ¨¶ÔºöÁúã‰ººÂú®ÈöêÂÜôÂú∫ÊôØ‰∏≠Ë¶ÅÂ∞ΩÂèØËÉΩ‰øùÁïôÔºå‰ΩÜ‰ªéÁªüËÆ°ÁâπÂæÅ‰∏äÁúãÔºåËøô‰∫õÂ≠óÁ¨¶Â±û‰∫éÈùûÂ∏∏Â∞ëËßÅÁöÑÂ≠óÁ¨¶Ôºå‰∏çÂ∫îËØ•‰∏ªÂä®ÊèêÈ´òÂàÜÂ∏ÉÁöÑÈ¢ëÁéá„ÄÇ
      //‰∏Ä‰∏™tokenÁ∫¶‰∏∫1-1.8‰∏™Ê±âÂ≠óÔºå0.75‰∏™ÂçïËØçÊàñ3-4‰∏™Â≠óÊØç
      //ÂøÖÈ°ªË¶Å‰øùÁïôÁöÑÂ≠óÁ¨¶ÔºàÈöèÊÑè‰∏≠Êñ≠Â∞Ü‰∏•ÈáçÁ†¥ÂùèËØ≠‰πâÔºâÔºöÂ≠óÊØç„ÄÅÊôÆÈÄöÁ©∫Ê†º„ÄÅËã±ÊñáÈÄóÂè∑„ÄÅËã±ÊñáÂè•Âè∑
      //Â∞ΩÈáè‰øùÁïôÁöÑÂ≠óÁ¨¶ÔºàÂì™ÊÄï‰∏ç‰∏≠Êñ≠‰πüËøòÊúâÂèØËÉΩÁª≠ÂÜôÔºâÔºö‰∏≠ÊñáÈÄóÂè∑„ÄÅ‰∏≠ÊñáÂè•Âè∑„ÄÅ‰∏≠ÊñáÂè≥ÂèåÂºïÂè∑„ÄÅÁöÑÔºà‰ΩøÁî®È¢ëÁéáÊúÄÈ´òÁöÑÊ±âÂ≠óÔºâ
      if (
        code === 32 ||
        code === 44 ||
        code === 46 || //ÊôÆÈÄöÁ©∫Ê†º„ÄÅËã±ÊñáÈÄóÂè∑„ÄÅËã±ÊñáÂè•Âè∑„ÄÅÂ§ßÂÜôÂ≠óÊØç„ÄÅÂ∞èÂÜôÂ≠óÊØç
        (code >= 65 && code <= 90) ||
        (code >= 97 && code <= 122) 
      )
        return 1;
      if (code === 65292 || code === 12290 || code === 8221 || code === 30340)
        //‰∏≠ÊñáÈÄóÂè∑Ôºå‰∏≠ÊñáÂè•Âè∑Ôºå‰∏≠ÊñáÂè≥ÂèåÂºïÂè∑„ÄÅÁöÑ„ÄÅ‰∏≠ÊñáÂè≥ÂçïÂºïÂè∑(||code===8217)
        return 2;
      return 3;
    }
    function testWeight(str) {
      let s = 0;
      for (const char of str) {
        s += getWeight(char.codePointAt(0));
      }
      return s;
    }
    // console.log('ÁöÑ'.codePointAt(0));
    const punctuations = ["Ôºü", "?", "ÔºÅ", "!", "„ÄÇ", "Ôºâ", ")", "‚Ä¶", "}", "]", "."]; //"\n"Âíå"‚Äù"ÊúâÊó∂ÂÄôÂπ∂‰∏ç‰ª£Ë°®ÁªìÂ∞æ
    async function completion(prompt, progress, tailCompletion) {
      let body = {
        prompt: prompt, //ÊîØÊåÅËæìÂÖ•Â§ö‰∏™prompt
        response_fields: tailCompletion ? ["content", "stopping_word"] : ["completion_probabilities", "tokens"],
        logit_bias: [["ÔøΩ", false]], //ÈÅøÂÖçÂú®Âà§Êñ≠‰∏çÂèØËß£Á†ÅÁöÑtokenÊó∂‰∫ßÁîüÂπ≤Êâ∞
        //stream: true
        //stop: ["</s>"],//chatÊ®°Âºè‰∏ãÈªòËÆ§‰∏∫["</s>", "Llama:", "User:"]
      };
      if (tailCompletion) {
        body["stop"] = punctuations; //Âä®ÊÄÅÊà™Êñ≠
      } else if (currentShuffle === 0) {
        body["n_predict"] = 1; //È¢ÑÊµãÁöÑÊúÄÂ§ßtokenÊï∞ÔºåÂ¶ÇÊûúÊúÄÂêé‰∏Ä‰∏™Ê†áËÆ∞ÊòØÈÉ®ÂàÜÂ§öÂ≠óËäÇÂ≠óÁ¨¶ÔºåÂàôÂèØËÉΩ‰ºöÁï•ÂæÆË∂ÖËøáËÆæÁΩÆÁöÑÈôêÂà∂„ÄÇ
        body["top_k"] = 75; //ÈÄâËØçËåÉÂõ¥ÔºåÈªòËÆ§40//ÈùûÁ∫øÊÄßtokenÊï∞ÁöÑÂèØË°åÊÄßÔºötokenÊï∞ËæÉÂ§öÊó∂ÔºåÂ¶ÇÊûúrollÂà∞ÂæàÂ∑ÆÁöÑtokenÔºåËøôÊ¨°ÈöêÂÜôÂ∞±ÁÉÇÂÆå‰∫ÜÔºõtokenËæÉÂ∞ëÊó∂ÔºåÂ¶ÇÊûúÂ§±Ë¥•ÂõûÊ∫ØÔºå‰∏ä‰∏ÄÂ±ÇÂâ©‰∏ãÁöÑÂÄôÈÄâtokenË¥®ÈáèÂè™‰ºöÊõ¥Â∑ÆÔºõËøò‰∏çÂ¶Ç‰∏ÄÂºÄÂßãÂ∞±ÈÄâ‰∏™Âõ∫ÂÆöÁöÑÁ®≥ÂÆöÁöÑÂÄº
        body["n_probs"] = 75; //ÊåâÊ¶ÇÁéáÊéíÂ∫èÁöÑÂâçn‰∏™ÈÄâËØçÔºåÂ¶ÇÊûútop_k‰∏çÂ§üÂ•ΩÂÉè‰ºöÊãø0ÂºÄÂßãÁöÑtokenË°•ÂÖ®
        body["post_sampling_probs"] = true; //ËøîÂõûÂ∫îÁî®ÈááÊ†∑ÈìæÂêétokenÁöÑÊ¶ÇÁéáÔºå‰∏çÂºÄÂêØÊó∂ËøîÂõûÁöÑlogprobÊòØÂíåÈááÊ†∑Êó†ÂÖ≥ÁöÑÔºålogitBias‰πü‰∏ç‰ºöÁîüÊïà
        body["return_tokens"] = true; //ÊàëÁõÆÂâç‰∏çÁ°ÆÂÆöÊòØÂê¶ËøòÂ≠òÂú®ËøîÂõûÊó†Ê≥ïËß£Á†ÅÁöÑtokenÁöÑÊÉÖÂÜµÔºåËøôÁßçÊÉÖÂÜµ‰∏ã‰ΩøÁî®ËØ•ÈÄâÈ°πÂèØËÉΩÊòØÊúâÂøÖË¶ÅÁöÑ
      } else {
        body["n_predict"] = 1;
        body["top_k"] = 25; //‰∏Ä‰∏™ÂêàÈÄÇÁöÑÂÄºËÉΩÂ§üÂπ≥Ë°°Â•ΩÊò†Â∞ÑÂ§±Ë¥•Ê¨°Êï∞ÂíåÊñáÊú¨Ë¥®ÈáèÔºå‰ΩÜÁî±‰∫éÈááÊ†∑ÁöÑÂΩ±ÂìçÔºåÊïàÊûúÂæàÊúâÈôê
        body["n_probs"] = 25;
        body["post_sampling_probs"] = true;
        body["return_tokens"] = true;
      }
      const response = await fetch("http://127.0.0.1:8090/completion", {
        method: "POST",
        body: JSON.stringify(body),
      });
      const json = await response.json();
      if (tailCompletion) {
        if (json.stopping_word) return json.content + json.stopping_word;
        return await completion(prompt, progress, true);
      }
      const t = json.completion_probabilities;
      //ÂΩìÈááÊ†∑ÁªìÊûúÊòØÊó†Ê≥ïËß£Á†ÅÁöÑtokenÔøΩÔºå‰∏ç‰ºöËøîÂõûÈááÊ†∑ÂàóË°®
      if (!t) {
        return [
          {
            id: json.tokens[0],
            token: " ",
            bytes: [255, 255],
            prob: 1,
          },
        ];
      }
      let result = t[0].top_probs.filter((item) => check(item.token)); //ÊâãÂä®Â§ÑÁêÜlogitBiasÊÑüËßâÊõ¥Âä†ÁÅµÊ¥ªÔºåËôΩÁÑ∂‰ºöÂØºËá¥tokenÊï∞‰∏çÂ§™Á®≥ÂÆö
      if (currentShuffle < result.length - 1) {
        //‰∏Ä‰∏™tokenÁöÑÊò†Â∞ÑÊàêÂäüÁéá‰øùÂÆà‰º∞ËÆ°‰∏∫1/3Â∑¶Âè≥Ôºà1/2Êò†Â∞ÑÂ§±Ë¥•ÔºåÂä†‰∏ÄÈÉ®ÂàÜÂ≠òÂú®Â§öÊ¨°Êò†Â∞ÑÔºâÔºåÈÇ£‰πàshuffle xÊ¨°ÁöÑÁßçÊï∞Êúâ2*(y/3)^xÔºåshuffleÊï∞ÈáèÁ∫øÊÄßÈÄíÂáè+ÊÄªÊï∞9Ê¨°+nÂèñ12ÔºåÊÄªÊï∞Á∫¶‰∏∫8005„ÄÇ‰ΩÜÊúâ‰∏ÄÁÇπÈúÄË¶ÅÊ≥®ÊÑèÔºåÂ∞ΩÂèØËÉΩÂºïÂØºÁî®Êà∑‰ΩøÁî®‰∏∞ÂØåÁöÑ‰ªªÂä°Ê®°ÊùøÂíåsystem promptÔºåÈÅøÂÖçÂÜÖÁΩÆËøô‰∫õÈÖçÁΩÆ
        return shuffle(result, 0, result.length - currentShuffle++); //Ê≠§ÂâçÊ†πÊçÆËøõÂ∫¶Êù•Âà§Êñ≠ÊòØÂê¶Ê∑∑Ê∑ÜÔºå‰ΩÜËøôÊ†∑ÂØπ‰∫éÁü≠ÊñáÊú¨Ê∑∑Ê∑ÜÊ¨°Êï∞‰∏çÂ§üÔºåÂØπ‰∫éÈïøÊñáÊú¨ÂèàÊòæÂæóÂ§ö‰Ωô
      }
      return result;
    }
    let base, currentPrompt, currentCoverText, currentShuffle, status, allowInsertion;
    async function dfs(i, tstr, tscore, incomplete) {
      if (status) return;
      const percents = i / base.length;
      const percent100 = percents * 100;
      el.progress.style.setProperty("--value", percent100);
      el.progress.setAttribute("aria-valuenow", percent100);
      const list = await completion(currentPrompt, percents, false); //Êï¥‰∏™dfsÈô§‰∫ÜcompletionÔºåÂá†‰πé‰∏çËÄóÊó∂Èó¥ÔºåÂõ†Ê≠§Âì™ÊÄïÊèêÂâçÂ∞ùËØïÁ¨¨‰∫åÊ¨°ËØ∑Ê±Ç‰πüÊòØÊ≤°ÊúâÊÑè‰πâÁöÑ
      // console.log(list)
      // let s=0;
      // for(let j=0;j<list.length;j++){
      //     const t=list[j].token;
      //     if(t===' ')console.log(list[j]);
      //
      //     // s+=testWeight(t);
      //     // console.log(`"${t}" "${testWeight(t)}"`)
      // }
      // console.log(s/list.length);
      for (let j = 0; j < list.length; j++) {
        if (status) return;
        let t;
        if (incomplete > 0) {
          const tokens = currentPrompt.slice(-incomplete);
          tokens.push(list[j].id);
          t = await detokenize(tokens);
          if (t.includes("ÔøΩ")) {
            currentPrompt.push(list[j].id);
            currentCoverText.push(list[j].id);
            await dfs(i, tstr, tscore, incomplete + 1);
            if (status) return;
            currentPrompt.pop();
            currentCoverText.pop();
            continue;
          }
          // console.log(t);
        } else {
          t = list[j].token;
          if ((t === " " && list[j].bytes.length >= 2) || t.includes("ÔøΩ")) {
            currentPrompt.push(list[j].id);
            currentCoverText.push(list[j].id);
            await dfs(i, tstr, tscore, incomplete + 1);
            if (status) return;
            currentPrompt.pop();
            currentCoverText.pop();
            continue;
          }
        }
        let ttstr = tstr,
          ttscore = tscore,
          sections = 0;
        for (let k = 0; ; k++) {
          if (status) return;
          if (k >= t.length) {
            currentPrompt.push(list[j].id);
            currentCoverText.push(list[j].id);
            el.coverText.value += t;
            await dfs(i + sections, ttstr, ttscore, 0);
            if (status) return; //Âú®ËøôÈáåreturnÈÅøÂÖçÈÄêÂ±ÇÂõûÊ∫ØÔºåÂØºËá¥ÊñáÊú¨Ê°ÜÂÜÖÂÆπÂèòÂåñ
            currentPrompt.pop();
            currentCoverText.pop();
            el.coverText.value = el.coverText.value.slice(0, -t.length);
            break; //ÂáèÂ∞ëdfs‰º†ÈÄíÁöÑÂÜÖÂ≠òÂç†Áî®
          }
          ttstr += t[k];
          ttscore += getWeight(t.codePointAt(k));
          if (t.codePointAt(k) > 0xffff) ttstr += [++k];
          if (ttscore >= 3) {
            if (h32(ttstr) % 2 !== base[i + sections]) break;
            sections++;
            ttstr = "";
            ttscore = 0; //‰ΩøÁî®-=3‰ºöÊèêÈ´òtokenÁöÑÂπ≥ÂùáÊò†Â∞ÑÊ¨°Êï∞ÔºåÈïøÁü≠tokenÁöÑ‰∏çÂπ≥Ë°°‰ºöÊõ¥Âä†ÊòéÊòæ
            if (i + sections === base.length) {
              status = true;
              if (allowInsertion) {
                currentCoverText.push(list[j].id);
                el.coverText.value += t;
                if (!punctuations.includes(el.coverText.value[el.coverText.value.length - 1]))                  //Â¶ÇÊûú‰∏çÂú®dfs‰∏≠Â§ÑÁêÜÔºåÈÇ£‰πàÂèñÊ∂àÈöêÂÜôÊó∂‰ªçÁÑ∂‰ºöÈ¢ùÂ§ñÊâßË°åË°•ÂÖ®„ÄÇ
                  el.coverText.value += await completion(currentPrompt, 1, true);
              } else el.coverText.value += t.slice(0, k + 1);
            }
          }
        }
      }
      // console.log('ÊµãËØïÊò†Â∞ÑÂ§±Ë¥•Ê¨°Êï∞')
    }
    const magicNum = [0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0];
    async function encrypt(prompt, plainText) {
      if (!el.progress.classList.contains("hidden")) {
        status = true;
        return;
      }
      if (!plainText) {
        el.secret.focus();
        return;
      }
      if (!prompt) {
        el.prompt.focus();
        return;
      }
      const compressed = await unishoxCompress(plainText);
      let [data, useUnishox] = compressed;
      let key = await readTextFile(el.publicKey);
      if (key) {
        data = await eccEncryptToUint8Array(data, JSON.parse(key));
      }
      // console.log(data);
      base = toBinary(data); //base=[useUnishox,...toBinary(data)];//Â§ÑÁêÜ‰∏∫‰∫åËøõÂà∂Â∫èÂàóÔºåÂú®Êò†Â∞ÑÊó∂Á≤íÂ∫¶Êõ¥ÁªÜÔºå‰ΩÜÂª∫ËÆÆÊØèÊ¨°Âè™Êò†Â∞Ñ1‰ΩçÔºåÂáèÂ∞ëÊò†Â∞ÑÂ§±Ë¥•Áéá„ÄÇ
      allowInsertion = get("insertion", true);
      if (allowInsertion) {
        if (data.length > 65535) {
          alert(dynamicContent(`ÂÜÖÂÆπËøáÂ§öÔºåËØ∑ÂáèÂ∞ëÂÜÖÂÆπÊàñÂÖ≥Èó≠ÂâçÂêéÊèíÂÖ•ÈÄâÈ°π`, `ÂÖßÂÆπÈÅéÂ§öÔºåË´ãÊ∏õÂ∞ëÂÖßÂÆπÊàñÈóúÈñâÂâçÂæåÊèíÂÖ•ÈÅ∏È†Ö`, `Too much content, please reduce the content or disable the prepend/append option`));
          return;
        }
        let length = new Uint8Array(2); //Â¶ÇÊûúÂÖàÂä†magic numÂÜçÂä†ÂØÜÔºåÈÇ£‰πàÂ∞±Ë¶ÅÂú®ÊØè‰∏™‰ΩçÁΩÆÈÉΩÂØªÊâæÈïøÂ∫¶>=(67*8)ÁöÑÊâÄÊúâÂ≠ê‰∏≤ÔºåÊ≠§Êó∂Â∞æÊèíÊó†ÂΩ±ÂìçÔºàÂõ†‰∏∫ÊòØÊåâÈ°∫Â∫èÂíåÊúÄÂ∞èÈïøÂ∫¶ÊâæËµ∑ÔºâÔºåÂ¶ÇÊûúÂ§¥ÊèíÊï∞Èáè‰∏∫n bitÔºåÂàôÂØªÊâæÊ¨°Êï∞‰∏∫n(n+1)/2ÔºåÂç≥ÊòØËØ¥Âè™ÊúâÂ∞ëÈáèÂ§¥ÊèíÁöÑÊÉÖÂÜµ‰∏ãÊâçËÉΩÊàêÂäü„ÄÇ//todo:ÂΩìÁî®Êà∑ÈÄâ‰∏≠ÂÖÅËÆ∏Â§¥Â∞æÊèíÂÖ•Êó∂ÔºåÊ∑ªÂä†ÈÄâÈ°π"ÈöêËîΩÁöÑÂä†ÂØÜ"ÔºöÂΩìÁªìÂêàÂä†ÂØÜ‰ΩøÁî®Êó∂ÔºåÈÅøÂÖçÂ¢ûÂä†ÈöêÂÜôÊö¥Èú≤ÁöÑÈ£éÈô©Ôºå‰ΩÜÂè™ÂÖÅËÆ∏Â§¥ÈÉ®ÊèíÂÖ•Â∞ëÈáèÊñáÊú¨„ÄÇËøôÈúÄÊ±ÇÊàëÁúã‰∫ÜÈÉΩÊÑüËßâÁª∑‰∏ç‰Ωè„ÄÇ
        length[0] = data.length / 256;
        length[1] = data.length % 256;
        base = [...magicNum, ...toBinary(length), ...base];
      }
      console.log(base);//1Âíå0ÁöÑÊØî‰æãÂ∑ÆË∑ù‰∏ÄËà¨‰∏çË∂ÖËøá10%
      await fetch("http://127.0.0.1:8090/props")
        .then((res) => res.json())
        .then(async (json) => {
          if (json.chat_template.includes("</think>")) {
            // prompt+="<think>";//ÊîØÊåÅÊÄùËÄÉÊ®°Âºè
            // await fetch('http://127.0.0.1:8090/completion', {method: 'POST',
            //     body: JSON.stringify({prompt:prompt,stop:["</think>"]}),
            // }).then(res=>res.json()).then(json=>{
            //     if(json.stopping_word)
            //         prompt+=json.content;
            // });
            // prompt+="</think>\n\n";
            prompt += "<think>\n</think>\n\n";
          }
        });
      currentPrompt = await tokenize(prompt);
      currentCoverText = [];
      el.coverText.value = "";
      currentShuffle = 0;
      status = false;
      el.progress.style.setProperty("--value", 0);
      el.progress.setAttribute("aria-valuenow", 0);
      el.progress.classList.remove("hidden");
      el.tooltip3.classList.remove("invisible");
      await dfs(0, "", 0, 0);
      el.tooltip3.classList.add("invisible");
      el.progress.classList.add("hidden");
      if (!status) alert(dynamicContent(`ËØ∑Â∞ùËØï‰ΩøÁî®Êõ¥Âä†ÂèëÊï£ÁöÑ‰ªªÂä°ÊèêÁ§∫ÔºåÊàñË∞ÉÊï¥ÂíåÂáèÂ∞ëËæìÂÖ•ÂÜÖÂÆπ`, `Ë´ãÂòóË©¶‰ΩøÁî®Êõ¥Âä†ÁôºÊï£ÁöÑ‰ªªÂãôÊèêÁ§∫ÔºåÊàñË™øÊï¥‰∏¶Ê∏õÂ∞ëËº∏ÂÖ•ÂÖßÂÆπ`, `Please try using a more divergent task prompt, or adjust and reduce the input content`), dynamicContent(`ÈöêÂÜôÂ§±Ë¥•ÔºÅ`, `Èö±ÂØ´Â§±ÊïóÔºÅ`, `Steganography failed!`));
    }
    async function extract(coverText) {
      if (!coverText) {
        el.coverText.focus();
        return;
      }
      let data;
      let tcoverText = coverText;
      for (; tcoverText; tcoverText = tcoverText.slice(1)) {
        let base = [],
          tstr = "",
          tscore = 0;
        for (const char of tcoverText) {
          tstr += char;
          tscore += getWeight(char.codePointAt(0));
          if (tscore >= 3) {
            base.push(h32(tstr) % 2);
            tstr = "";
            tscore = 0;
          }
        }
        let index = findSublistIndex(base, magicNum);
        if (index == -1) continue;
        // console.log(base)
        index += 24;
        let length = 0;
        for (let i = 0; i < 16; i++) {
          length += base[index + i] * (1 << (15 - i));
        }
        index += 16;
        base = base.slice(index, index + length * 8);
        data = toBytes(base);
        break;
      }
      if (!data) {
        let base = [],
          tstr = "",
          tscore = 0;
        for (const char of coverText) {
          tstr += char;
          tscore += getWeight(char.codePointAt(0));
          if (tscore >= 3) {
            base.push(h32(tstr) % 2);
            tstr = "";
            tscore = 0;
          }
        }
        data = toBytes(base);
      }
      // console.log(base)// let useUnishox=base[0];base=base.slice(1);
      let key = await readTextFile(el.privateKey);
      if (key) {
        data = await eccDecryptToUint8Array(data, JSON.parse(key));
      }
      el.secret.value = await unishoxDecompress(data); // el.secret.value=await unishoxDecompress(data,useUnishox);
    }
    el.hide.onclick = async () => {
      await encrypt(el.prompt.value, el.secret.value);
    };
    el.extract.onclick = async () => {
      await extract(el.coverText.value);
    };
    //todo:Âú®Ê®°ÊùøÂ±ÇÂÖ≥Èó≠ÊÄùËÄÉÊ®°Âºè
    //todo:ÊâæÂà∞‰∏ÄÁßçË∂≥Â§üÈÄöÁî®ÁöÑsystem promptÊ≥®ÂÖ•ÊñπÂºè
    //todo:unishox3„ÄÅÈ´òÈ¢ëËØç„ÄÅ‰ª•ÊúÄÂ§ßÈïøÂ∫¶Áâ∫Áâ≤8ÂÄç‰∏∫‰ª£‰ª∑ËäÇÁ∫¶3.5bitÔºü
    //todo:logit_bias„ÄÅtokenËøáÊª§„ÄÅÈááÊ†∑ÂèÇÊï∞Ë∞ÉÊï¥Á≠âÊñπÂºèÊèêÈ´òtokenË¥®Èáè
    //todo:ÂèòÈïøÁºñÁ†ÅÊù•Ë°®Á§∫ÈïøÂ∫¶ÔºåVLQ/LEB128ÈÄöÂ∏∏‰∏∫Â≠óËäÇ‰∏∫Âçï‰ΩçÔºåElias Gamma/Delta/ Omega ÁºñÁ†ÅÂèØ‰ª•Á≤æÁ°ÆÂà∞‰Ωç
    //todo:ÁõÆÂâçÁöÑÂ∞æÈÉ®Ë°•ÂÖ®ÁöÑÊú∫Âà∂Ëøá‰∫éÁÆÄÈôãÔºå‰πü‰∏ç‰∏ÄÂÆöÈÄÇÂêàÊâÄÊúâËØ≠Ë®ÄÔºåÊÄªÊúâ‰∏ÄÂ§©‰ºöÂá∫Áé∞ÈóÆÈ¢ò„ÄÇ
    //warning:Èô§ÈùûÊúâÈùûÂ∏∏Â§ßÁöÑÊîπËøõÔºåÂê¶ÂàôÁ¶ÅÊ≠¢Ë∞ÉÊï¥Ëß£Á†ÅÁ≠ñÁï•ÔºõËÄå‰∏îËøòË¶Å‰∏∫ÊóßÁâàÊú¨ÁöÑËß£Á†ÅÈÉ®ÁΩ≤È°µÈù¢Ôºõ
    //‰∏ÄÁßçÁâ∫Áâ≤ÈöêÂÜôÂÆπÈáèÊèêÈ´òÈ≤ÅÊ£íÊÄßÂíåÈöêÂÜôÊïàÊûúÁöÑÊñπÊ≥ïÔºöÈÉ®ÂàÜÊà™ÂèñÁâáÊÆµÁõ¥Êé•‰ΩøÁî®Ôºå‰∏çÂ∞ùËØïÊò†Â∞Ñ
    //ÊòØÂê¶Â∫îËØ•ÊîØÊåÅÊõ¥Êñ∞Ôºü‰∏çËøáÁî±‰∫éÊòØesmÔºåÊìç‰ΩúÊñá‰ª∂ËøòÊòØÂæàÈ∫ªÁÉ¶ÁöÑ
    // fetch('http://127.0.0.1:8090/props').then(res=>res.json()).then(json=>console.log(json));
  </script>
</Layout>