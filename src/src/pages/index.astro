---
import Layout from "../layouts/Layout.astro";
---
<Layout title="StegLLM">
  <div class="flex justify-between items-center shadow p-4">{/*justify-betweenæ°´å¹³æ–¹å‘ä¸Šåˆ†å¸ƒä¸¤ç«¯ï¼Œitems-centerç«–ç›´æ–¹å‘å±…ä¸­*/}
    <div>
      <button class="btn btn-soft btn-accent btn-sm" id="import"></button>
      <button class="btn btn-soft btn-accent btn-sm" id="export"></button>
      <button class="btn btn-soft btn-warning btn-sm" id="generateKeyPair"></button>
    </div>
    <div>
      <div class="dropdown dropdown-center">
        <div tabindex="0" role="button" class="btn btn-ghost px-2" id="lang">
          <svg class="size-6" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 0 1-3.827-5.802"/></svg>
        </div>
        <ul class="dropdown-content bg-base-200 z-1 w-20">
          <li>
            <input type="radio" name="lang-dropdown" class="btn btn-sm btn-block btn-ghost" aria-label="ç®€ä½“ä¸­æ–‡" value="zh-Hans" />
          </li>
          <li>
            <input type="radio" name="lang-dropdown" class="btn btn-sm btn-block btn-ghost" aria-label="æ­£é«”ä¸­æ–‡" value="zh-Hant" />
          </li>
          <li>
            <input type="radio" name="lang-dropdown" class="btn btn-sm btn-block btn-ghost" aria-label="English" value="en" />
          </li>
        </ul>
      </div>
      <div class="dropdown dropdown-center">
        <div tabindex="0" role="button" class="btn btn-ghost px-2" id="theme">
          <svg class="size-6" fill="currentColor" viewBox="0 0 16 16"><path d="M12.433 10.07C14.133 10.585 16 11.15 16 8a8 8 0 1 0-8 8c1.996 0 1.826-1.504 1.649-3.08-.124-1.101-.252-2.237.351-2.92.465-.527 1.42-.237 2.433.07M8 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m4.5 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3M5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/></svg>
        </div>
        <ul class="dropdown-content bg-base-200 z-1">
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="ğŸŒš" value="default" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="ğŸŒ" value="light" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="ğŸŒ¸" value="valentine" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="ğŸ“œ" value="retro" />
          </li>
          <li>
            <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost" aria-label="â˜•" value="coffee" />
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="flex flex-col p-6 mx-4 lg:mx-12 2xl:mx-40">
    <div class="flex flex-col md:flex-row gap-6 lg:gap-12">
      <div class="rounded-lg py-6 flex flex-col gap-6 flex-1">
        <textarea class="textarea textarea-info w-full h-136 bg-base-200 rounded-lg resize-none" id="secret"></textarea>
        <fieldset class="fieldset">
          <div class="tooltip" id="tooltip">
            <legend class="fieldset-legend" id="publicKeyTitle"></legend>
          </div>
          <div class="flex flex-row gap-6 items-center">
              <input type="file" class="file-input file-input-success" id="publicKey" disabled={!!Astro.site} />
              <div class="tooltip" id="tooltip2">
          <fieldset class="fieldset">
            <label class="fieldset-label">
              <input type="checkbox" class="toggle toggle-info" id="insertion" disabled={!!Astro.site}/>
              <span id="insertionText"></span>
            </label>
          </fieldset>
        </div>
          </div>
        </fieldset>
      </div>
      <div class="flex flex-col items-center justify-center gap-8">
        <div class="tooltip invisible" id="tooltip3">
          <button class=`btn btn-primary btn-circle btn-xl visible ${Astro.site&&"btn-disabled"}` id="hide">
            <svg class="size-6" viewBox="0 0 24 24"><path fill="currentColor" d="M10.5 15h3l-.575-3.225q.5-.25.788-.725T14 10q0-.825-.587-1.412T12 8t-1.412.588T10 10q0 .575.288 1.05t.787.725zm1.5 7q-3.475-.875-5.738-3.988T4 11.1V5l8-3l8 3v6.1q0 3.8-2.262 6.913T12 22"></path></svg>
          </button>
        </div>
        <button class="btn btn-secondary btn-circle btn-xl" id="extract">
          <svg class="size-6" viewBox="0 0 24 24"><path fill="currentColor" d="M18 1c-2.76 0-5 2.24-5 5v2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12c1.11 0 2-.89 2-2V10a2 2 0 0 0-2-2h-1V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2h2V6c0-2.76-2.24-5-5-5m-8 12a2 2 0 0 1 2 2c0 1.11-.89 2-2 2a2 2 0 1 1 0-4"></path></svg>
        </button>
      </div>
      <div class="rounded-lg py-6 flex flex-col gap-6 flex-1">
        <textarea class="textarea textarea-info w-full h-136 bg-base-200 rounded-lg resize-none" id="coverText"></textarea>
        <fieldset class="fieldset">
          <legend class="fieldset-legend" id="privateKeyTitle"></legend>
          <input type="file" class="file-input file-input-warning" id="privateKey" />
        </fieldset>
      </div>
    </div>
    <progress class="progress progress-primary hidden" value="0" max="100" id="progress"></progress>
  </div>
  <div class="flex flex-row gap-4 items-center mb-10 mx-4 lg:mx-12 2xl:mx-40 px-6">
      <textarea class="textarea textarea-info w-full h-26 bg-base-200 rounded-lg resize-none" id="prompt" disabled={!!Astro.site}></textarea>
      <div class="flex flex-col">
        <button class=`btn btn-ghost ${Astro.site&&"btn-disabled"}` id="up">â–²</button>
        <button class=`btn btn-ghost ${Astro.site&&"btn-disabled"}` id="down">â–¼</button>
      </div>
      <button class=`btn btn-info ${Astro.site&&"btn-disabled"}` id="save"></button>
  </div>
  <script>
    import { $,init, get, set, add, runIfMatch, generateKeyPair, exportLocalStorage, importLocalStorage, unishoxCompress, readTextFile, eccEncryptToUint8Array, eccDecryptToUint8Array, shuffle, toBinary, toBytes, findSublistIndex, unishoxDecompress, tokenize, detokenize, check,stringToUnicode } from "../utils/commonUtils";
    function modal(msg = null, title = null , cancel=null,confirm=null) {
      if(title) $('modalTitle').textContent = title;
      $('modalMsg').textContent = msg;
      $('cancel').textContent = cancel?cancel:dynamicContent("ç¡®å®š","ç¢ºå®š","OK");
      $('confirm').classList.add("invisible");
      if(confirm){
        $('confirm').classList.remove("invisible");
        $('confirm').textContent=confirm;
      }
      $('modal').showModal();
    }
    init();
    function assignStrs(strs) {
      [$('import').textContent, $('export').textContent, $('generateKeyPair').textContent, $('publicKeyTitle').textContent, $('privateKeyTitle').textContent, $('publicKey').ariaLabel, $('privateKey').ariaLabel, $('secret').placeholder, $('coverText').placeholder, $('prompt').placeholder,$('lang').ariaLabel, $('theme').ariaLabel, $('hide').ariaLabel, $('extract').ariaLabel, $('save').textContent, $('insertionText').textContent] = strs;
    }
    function setLang() {
      document.documentElement.lang=get("lang","zh-Hans");
      runIfMatch(
        "lang",
        "zh-Hans",
        {
          "zh-Hans": ["å¯¼å…¥é…ç½®", "å¯¼å‡ºé…ç½®", "ç”Ÿæˆå¯†é’¥", "è¾“å…¥æ¥æ”¶æ–¹çš„å…¬é’¥ï¼ˆå¯é€‰ï¼‰", "è¾“å…¥ä½ çš„ç§é’¥ï¼ˆå¯é€‰ï¼‰", "è¾“å…¥æ¥æ”¶æ–¹çš„å…¬é’¥ï¼ˆå¯é€‰ï¼‰", "è¾“å…¥ä½ çš„ç§é’¥ï¼ˆå¯é€‰ï¼‰", "è¯·è¾“å…¥éœ€è¦åŠ å¯†çš„ä¿¡æ¯", "è¯·è¾“å…¥éœ€è¦è§£å¯†çš„æ©é¥°æ–‡æœ¬", `è¯·è¾“å…¥ä»»åŠ¡æç¤ºï¼Œä¾‹å¦‚ï¼š"ç»­å†™ä¸€æ®µæ•£æ–‡ï¼š"\nç‚¹å‡»å³ä¾§çš„æŒ‰é’®å¯ä»¥ä¿å­˜å½“å‰ä»»åŠ¡æç¤º`,"è¯­è¨€", "ä¸»é¢˜", "éšå†™", "æå–", "ä¿å­˜", "æ”¯æŒå‰åæ’å…¥"],
          "zh-Hant": ["å°å…¥é…ç½®", "å°å‡ºé…ç½®", "ç”Ÿæˆå¯†é‘°", "è¼¸å…¥æ¥æ”¶æ–¹çš„å…¬é‘°ï¼ˆå¯é¸ï¼‰", "è¼¸å…¥ä½ çš„ç§é‘°ï¼ˆå¯é¸ï¼‰", "è¼¸å…¥æ¥æ”¶æ–¹çš„å…¬é‘°ï¼ˆå¯é¸ï¼‰", "è¼¸å…¥ä½ çš„ç§é‘°ï¼ˆå¯é¸ï¼‰", "è«‹è¼¸å…¥éœ€è¦åŠ å¯†çš„ä¿¡æ¯", "è«‹è¼¸å…¥éœ€è¦è§£å¯†çš„æ©é£¾æ–‡æœ¬", "è«‹è¼¸å…¥ä»»å‹™æç¤ºï¼Œä¾‹å¦‚ï¼šã€ŒçºŒå¯«ä¸€æ®µæ•£æ–‡ï¼šã€\né»æ“Šå³å´çš„æŒ‰éˆ•å¯ä»¥ä¿å­˜ç•¶å‰ä»»å‹™æç¤º","èªè¨€", "ä¸»é¡Œ", "éš±å¯«", "æå–", "ä¿å­˜", "æ”¯æŒå‰å¾Œæ’å…¥"],
          "en": ["Import Configuration", "Export Configuration", "Generate Key", "Enter Recipient's Public Key (Optional)", "Enter Your Private Key (Optional)", "Enter Recipient's Public Key (Optional)", "Enter Your Private Key (Optional)", "Please Enter the Information to Encrypt", "Please Enter the Masked Text to Decrypt", 'Please Enter the Task Prompt, e.g., "Continue Writing an Essay: "\nClick the Button on the Right to Save the Current Task Prompt',"Language", "Theme", "Steganography", "Extract", "Save", "Support Insertion Before and After"],
        },
        (strs) => {
          assignStrs(strs);
        }
      );
      $('tooltip').setAttribute("data-tip", dynamicContent("å³ä½¿éšå†™æš´éœ²ï¼Œä¹Ÿèƒ½ç¡®ä¿åŸå§‹ä¿¡æ¯ä¸ä¼šè¢«ç ´è§£", "å³ä½¿éš±å¯«æš´éœ²ï¼Œä¹Ÿèƒ½ç¢ºä¿åŸå§‹ä¿¡æ¯ä¸æœƒè¢«ç ´è§£", "Even if the Steganography is Exposed, It Ensures the Original Information Cannot Be Cracked"));
      $('tooltip2').setAttribute("data-tip", dynamicContent("ç”Ÿæˆçš„æ©é¥°æ–‡æœ¬åµŒå…¥åˆ°ä»»æ„æ–‡æœ¬åä»èƒ½å‡†ç¡®è§£å¯†ï¼Œç•¥å¾®å¢åŠ éšå†™æš´éœ²çš„é£é™©", "ç”Ÿæˆçš„æ©é£¾æ–‡æœ¬åµŒå…¥åˆ°ä»»æ„æ–‡æœ¬å¾Œä»èƒ½æº–ç¢ºè§£å¯†ï¼Œç•¥å¾®å¢åŠ éš±å¯«æš´éœ²çš„é¢¨éšª", "The generated cover text can still be accurately decrypted after being embedded into any text, slightly increasing the risk of steganographic exposure"));
      $('tooltip3').setAttribute("data-tip", dynamicContent("å†æ¬¡ç‚¹å‡»ä»¥åœæ­¢éšå†™", "å†æ¬¡é»æ“Šä»¥åœæ­¢éš±å¯«", "Click again to stop steganography"));
    }
    function dynamicContent(...strs) {
      return runIfMatch(
        "lang",
        "zh-Hans",
        {
          "zh-Hans": strs[0],
          "zh-Hant": strs[1],
          "en": strs[2],
        },
        (value) => {
          return value;
        }
      );
    }
    function setInsertion() {
      $('insertion').checked = get("insertion", true);
    }
    const langButtons = document.querySelectorAll(`input[name="lang-dropdown"]`);
    langButtons.forEach((button) => {
      button.addEventListener("change", function (event) {
        if (event.target.checked) {
          set("lang", event.target.value);
          setLang();
        }
      });
    });
    $('insertion').addEventListener("change", function (event) {
      set("insertion", event.target.checked);
    });
    $('generateKeyPair').onclick = async () => {
      await generateKeyPair();
      modal(dynamicContent(`è¯·å®‰å…¨åœ°ä¿å­˜ä½ çš„ç§é’¥ï¼Œå¹¶æå‰å’Œæ¥æ”¶æ–¹äº¤æ¢å…¬é’¥`, `è«‹å®‰å…¨åœ°ä¿å­˜ä½ çš„ç§é‘°ï¼Œä¸¦æå‰èˆ‡æ¥æ”¶æ–¹äº¤æ›å…¬é‘°`, `Please securely save your private key and exchange public keys with the recipient in advance`), dynamicContent("æˆåŠŸï¼", "æˆåŠŸï¼", "Success!"));
    };
    $('export').onclick = () => {
      exportLocalStorage();
    };
    $('import').onclick = async () => {
      await importLocalStorage();
      initConfig();
    };
    let prompts;
    let i;
    $('up').onclick = () => {
      i = (i + 1) % prompts.length;
      set("promptIndex", i);
      $('prompt').value = prompts[i];
    };
    $('down').onclick = () => {
      i = (i - 1 + prompts.length) % prompts.length;
      set("promptIndex", i);
      $('prompt').value = prompts[i];
    };
    $('save').onclick = () => {
      if ($('prompt').value) {
        add("prompts", $('prompt').value);
        prompts = get("prompts", [""]);
        i = prompts.length - 1;
        set("promptIndex", i);
        modal("", dynamicContent(`ä¿å­˜æˆåŠŸï¼`, `å„²å­˜æˆåŠŸï¼`, `Saved successfully!`));
      } else {
        add("prompts", null, i);
        prompts = get("prompts", [""]);
        i = prompts.length - 1;
        $('prompt').value = prompts[i];
        set("promptIndex", i);
        modal("", dynamicContent(`åˆ é™¤æˆåŠŸï¼`, `åˆªé™¤æˆåŠŸï¼`, `Deleted successfully!`));
      }
    };
    function initConfig() {
      setInsertion();
      prompts = get("prompts", [""]);
      i = get("promptIndex", prompts.length - 1);
      $('prompt').value = prompts[i];
    }
    setLang();
    initConfig();
async function sha512Mod2(str) {
  const hashBuffer = await crypto.subtle.digest('SHA-512', new TextEncoder().encode(str)); //sha256/384/512
  const hashArray = new Uint8Array(hashBuffer);
  return hashArray[hashArray.length - 1] & 1;
}
    function getWeight(code) {
      //scoreå€¼è¶Šå°ï¼Œå­—ç¬¦è¢«ä¿ç•™çš„æ¦‚ç‡è¶Šé«˜ã€‚
      //é›¶å®½å­—ç¬¦ï¼šçœ‹ä¼¼åœ¨éšå†™åœºæ™¯ä¸­è¦å°½å¯èƒ½ä¿ç•™ï¼Œä½†ä»ç»Ÿè®¡ç‰¹å¾ä¸Šçœ‹ï¼Œè¿™äº›å­—ç¬¦å±äºéå¸¸å°‘è§çš„å­—ç¬¦ï¼Œä¸åº”è¯¥ä¸»åŠ¨æé«˜åˆ†å¸ƒçš„é¢‘ç‡ã€‚
      //ä¸€ä¸ªtokençº¦ä¸º1-1.8ä¸ªæ±‰å­—ï¼Œ0.75ä¸ªå•è¯æˆ–3-4ä¸ªå­—æ¯
      //å¿…é¡»è¦ä¿ç•™çš„å­—ç¬¦ï¼ˆéšæ„ä¸­æ–­å°†ä¸¥é‡ç ´åè¯­ä¹‰ï¼‰ï¼šå­—æ¯ã€æ™®é€šç©ºæ ¼ã€è‹±æ–‡é€—å·ã€è‹±æ–‡å¥å·
      //å°½é‡ä¿ç•™çš„å­—ç¬¦ï¼ˆå“ªæ€•ä¸ä¸­æ–­ä¹Ÿè¿˜æœ‰å¯èƒ½ç»­å†™ï¼‰ï¼šä¸­æ–‡é€—å·ã€ä¸­æ–‡å¥å·ã€ä¸­æ–‡å³åŒå¼•å·ã€çš„ï¼ˆä½¿ç”¨é¢‘ç‡æœ€é«˜çš„æ±‰å­—ï¼‰
      if (
        code === 32 ||
        code === 44 ||
        code === 46 || //æ™®é€šç©ºæ ¼ã€è‹±æ–‡é€—å·ã€è‹±æ–‡å¥å·ã€å¤§å†™å­—æ¯ã€å°å†™å­—æ¯
        (code >= 65 && code <= 90) ||
        (code >= 97 && code <= 122) 
      )
        return 1;
      if (code === 65292 || code === 12290 || code === 8221 || code === 30340)
        //ä¸­æ–‡é€—å·ï¼Œä¸­æ–‡å¥å·ï¼Œä¸­æ–‡å³åŒå¼•å·ã€çš„ã€ä¸­æ–‡å³å•å¼•å·(||code===8217)
        return 2;
      return 3;
    }
    // function testWeight(str) {
    //   let s = 0;
    //   for (const char of str) {
    //     s += getWeight(char.codePointAt(0));
    //   }
    //   return s;
    // }
    // console.log('çš„'.codePointAt(0));
    const punctuations = ["ï¼Ÿ", "?", "ï¼", "!", "ã€‚", "ï¼‰", ")", "â€¦", "}", "]", "."]; //"\n"å’Œ"â€"æœ‰æ—¶å€™å¹¶ä¸ä»£è¡¨ç»“å°¾
    let logitBias=[];
    if (window.location.hostname === "127.0.0.1") {
        logitBias=[[(await tokenize("ï¿½"))[0], false],//é¿å…åœ¨åˆ¤æ–­ä¸å¯è§£ç çš„tokenæ—¶äº§ç”Ÿå¹²æ‰°
          //[(await tokenize("<|im_end|>"))[0],false]
        ];
    }
    async function completion(prompt, progress, tailCompletion) {
      let body = {
        prompt: prompt, //æ”¯æŒè¾“å…¥å¤šä¸ªprompt
        response_fields: tailCompletion ? ["content", "stopping_word"] : ["completion_probabilities", "tokens"],
        logit_bias: logitBias, 
        //stop: ["</s>"],//chatæ¨¡å¼ä¸‹é»˜è®¤ä¸º["</s>", "Llama:", "User:"]
      };
      if (tailCompletion) {
        body["stop"] = punctuations; //åŠ¨æ€æˆªæ–­
      } else if (currentShuffle === 0) {
        body["n_predict"] = 1; //é¢„æµ‹çš„æœ€å¤§tokenæ•°ï¼Œå¦‚æœæœ€åä¸€ä¸ªæ ‡è®°æ˜¯éƒ¨åˆ†å¤šå­—èŠ‚å­—ç¬¦ï¼Œåˆ™å¯èƒ½ä¼šç•¥å¾®è¶…è¿‡è®¾ç½®çš„é™åˆ¶ã€‚
        body["top_k"] = 75; //é€‰è¯èŒƒå›´ï¼Œé»˜è®¤40//éçº¿æ€§tokenæ•°çš„å¯è¡Œæ€§ï¼štokenæ•°è¾ƒå¤šæ—¶ï¼Œå¦‚æœrollåˆ°å¾ˆå·®çš„tokenï¼Œè¿™æ¬¡éšå†™å°±çƒ‚å®Œäº†ï¼›tokenè¾ƒå°‘æ—¶ï¼Œå¦‚æœå¤±è´¥å›æº¯ï¼Œä¸Šä¸€å±‚å‰©ä¸‹çš„å€™é€‰tokenè´¨é‡åªä¼šæ›´å·®ï¼›è¿˜ä¸å¦‚ä¸€å¼€å§‹å°±é€‰ä¸ªå›ºå®šçš„ç¨³å®šçš„å€¼
        body["n_probs"] = 75; //æŒ‰æ¦‚ç‡æ’åºçš„å‰nä¸ªé€‰è¯ï¼Œå¦‚æœtop_kä¸å¤Ÿå¥½åƒä¼šæ‹¿0å¼€å§‹çš„tokenè¡¥å…¨
        body["post_sampling_probs"] = true; //è¿”å›åº”ç”¨é‡‡æ ·é“¾åtokençš„æ¦‚ç‡ï¼Œä¸å¼€å¯æ—¶è¿”å›çš„logprobæ˜¯å’Œé‡‡æ ·æ— å…³çš„ï¼ŒlogitBiasä¹Ÿä¸ä¼šç”Ÿæ•ˆ
        body["return_tokens"] = true; //æˆ‘ç›®å‰ä¸ç¡®å®šæ˜¯å¦è¿˜å­˜åœ¨è¿”å›æ— æ³•è§£ç çš„tokençš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥é€‰é¡¹å¯èƒ½æ˜¯æœ‰å¿…è¦çš„
      } else {
        body["n_predict"] = 1;
        body["top_k"] = 25; //ä¸€ä¸ªåˆé€‚çš„å€¼èƒ½å¤Ÿå¹³è¡¡å¥½æ˜ å°„å¤±è´¥æ¬¡æ•°å’Œæ–‡æœ¬è´¨é‡ï¼Œä½†ç”±äºé‡‡æ ·çš„å½±å“ï¼Œæ•ˆæœå¾ˆæœ‰é™
        body["n_probs"] = 25;
        body["post_sampling_probs"] = true;
        body["return_tokens"] = true;
      }
      const response = await fetch("http://127.0.0.1:8090/completion", {
        method: "POST",
        body: JSON.stringify(body),
      });
      const json = await response.json();
      if (tailCompletion) {
        if (json.stopping_word) return json.content + json.stopping_word;
        return await completion(prompt, progress, true);
      }
      const t = json.completion_probabilities;
      //å½“é‡‡æ ·ç»“æœæ˜¯æ— æ³•è§£ç çš„tokenï¿½ï¼Œä¸ä¼šè¿”å›é‡‡æ ·åˆ—è¡¨
      if (!t) {
        return [
          {
            id: json.tokens[0],
            token: " ",
            bytes: [255, 255],
            prob: 1,
          },
        ];
      }
      let result = t[0].top_probs.filter((item) => check(item.token)); //æ‰‹åŠ¨å¤„ç†logitBiasæ„Ÿè§‰æ›´åŠ çµæ´»ï¼Œè™½ç„¶ä¼šå¯¼è‡´tokenæ•°ä¸å¤ªç¨³å®š
      if (currentShuffle < result.length - 1) {
        //ä¸€ä¸ªtokençš„æ˜ å°„æˆåŠŸç‡ä¿å®ˆä¼°è®¡ä¸º1/3å·¦å³ï¼ˆ1/2æ˜ å°„å¤±è´¥ï¼ŒåŠ ä¸€éƒ¨åˆ†å­˜åœ¨å¤šæ¬¡æ˜ å°„ï¼‰ï¼Œé‚£ä¹ˆshuffle xæ¬¡çš„ç§æ•°æœ‰2*(y/3)^xï¼Œshuffleæ•°é‡çº¿æ€§é€’å‡+æ€»æ•°9æ¬¡+nå–12ï¼Œæ€»æ•°çº¦ä¸º8005ã€‚ä½†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå°½å¯èƒ½å¼•å¯¼ç”¨æˆ·ä½¿ç”¨ä¸°å¯Œçš„ä»»åŠ¡æ¨¡æ¿å’Œsystem promptï¼Œé¿å…å†…ç½®è¿™äº›é…ç½®
        return shuffle(result, 0, result.length - currentShuffle++); //æ­¤å‰æ ¹æ®è¿›åº¦æ¥åˆ¤æ–­æ˜¯å¦æ··æ·†ï¼Œä½†è¿™æ ·å¯¹äºçŸ­æ–‡æœ¬æ··æ·†æ¬¡æ•°ä¸å¤Ÿï¼Œå¯¹äºé•¿æ–‡æœ¬åˆæ˜¾å¾—å¤šä½™
      }
      return result;
    }
    let base, currentPrompt, currentCoverText, currentShuffle, status, allowInsertion;
    async function dfs(i, tstr, tscore, incomplete) {
      if (status) return;
      const percents = i / base.length;
      $('progress').value=percents * 100;
      const list = await completion(currentPrompt, percents, false); //æ•´ä¸ªdfsé™¤äº†completionï¼Œå‡ ä¹ä¸è€—æ—¶é—´ï¼Œå› æ­¤å“ªæ€•æå‰å°è¯•ç¬¬äºŒæ¬¡è¯·æ±‚ä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„
      // console.log(list)
      // let s=0;
      // for(let j=0;j<list.length;j++){
      //     const t=list[j].token;
      //     if(t===' ')console.log(list[j]);
      //
      //     // s+=testWeight(t);
      //     // console.log(`"${t}" "${testWeight(t)}"`)
      // }
      // console.log(s/list.length);
      for (let j = 0; j < list.length; j++) {
        if (status) return;
        let t;
        if (incomplete > 0) {
          const tokens = currentPrompt.slice(-incomplete);
          tokens.push(list[j].id);
          t = await detokenize(tokens);
          if (t.includes("ï¿½")) {
            currentPrompt.push(list[j].id);
            currentCoverText.push(list[j].id);
            await dfs(i, tstr, tscore, incomplete + 1);
            if (status) return;
            currentPrompt.pop();
            currentCoverText.pop();
            continue;
          }
          // console.log(t);
        } else {
          t = list[j].token;
          if ((t === " " && list[j].bytes.length >= 2) || t.includes("ï¿½")) {
            currentPrompt.push(list[j].id);
            currentCoverText.push(list[j].id);
            await dfs(i, tstr, tscore, incomplete + 1);
            if (status) return;
            currentPrompt.pop();
            currentCoverText.pop();
            continue;
          }
        }
        let ttstr = tstr,
          ttscore = tscore,
          sections = 0;
        for (let k = 0; ; k++) {
          if (status) return;
          if (k >= t.length) {
            currentPrompt.push(list[j].id);
            currentCoverText.push(list[j].id);
            $('coverText').value += t;
            await dfs(i + sections, ttstr, ttscore, 0);
            if (status) return; //åœ¨è¿™é‡Œreturné¿å…é€å±‚å›æº¯ï¼Œå¯¼è‡´æ–‡æœ¬æ¡†å†…å®¹å˜åŒ–
            currentPrompt.pop();
            currentCoverText.pop();
            $('coverText').value = $('coverText').value.slice(0, -t.length);
            break; //å‡å°‘dfsä¼ é€’çš„å†…å­˜å ç”¨
          }
          ttstr += t[k];
          ttscore += getWeight(t.codePointAt(k));
          if (t.codePointAt(k) > 0xffff) ttstr += [++k];
          if (ttscore >= 3) {
            if ((await sha512Mod2(ttstr)) !== base[i + sections]) break;
            sections++;
            ttstr = "";
            ttscore = 0; //ä½¿ç”¨-=3ä¼šæé«˜tokençš„å¹³å‡æ˜ å°„æ¬¡æ•°ï¼Œé•¿çŸ­tokençš„ä¸å¹³è¡¡ä¼šæ›´åŠ æ˜æ˜¾
            if (i + sections === base.length) {
              status = true;
              if (allowInsertion) {
                currentCoverText.push(list[j].id);
                $('coverText').value += t;
                if (!punctuations.includes($('coverText').value[$('coverText').value.length - 1]))                  //å¦‚æœä¸åœ¨dfsä¸­å¤„ç†ï¼Œé‚£ä¹ˆå–æ¶ˆéšå†™æ—¶ä»ç„¶ä¼šé¢å¤–æ‰§è¡Œè¡¥å…¨ã€‚
                  $('coverText').value += await completion(currentPrompt, 1, true);
              } else $('coverText').value += t.slice(0, k + 1);
            }
          }
        }
      }
      // console.log('æµ‹è¯•æ˜ å°„å¤±è´¥æ¬¡æ•°')
    }
    const magicNum1 = [1,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,1];
    const magicNum2 = [0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,1,1,0,0];
    async function encrypt(prompt, plainText) {
      if (!$('progress').classList.contains("hidden")) {
        status = true;
        return;
      }
      if (!plainText) {
        $('secret').focus();
        return;
      }
      if (!prompt) {
        $('prompt').focus();
        return;
      }
      const compressed = await unishoxCompress(plainText);
      let [data, useUnishox] = compressed;
      let key = await readTextFile($('publicKey'));
      if (key) {
        data = await eccEncryptToUint8Array(data, JSON.parse(key));
      }
      // console.log(data);
      base = toBinary(data); //base=[useUnishox,...toBinary(data)];//å¤„ç†ä¸ºäºŒè¿›åˆ¶åºåˆ—ï¼Œåœ¨æ˜ å°„æ—¶ç²’åº¦æ›´ç»†ï¼Œä½†å»ºè®®æ¯æ¬¡åªæ˜ å°„1ä½ï¼Œå‡å°‘æ˜ å°„å¤±è´¥ç‡ã€‚
      allowInsertion = get("insertion", true);
      //console.log(base)
      const end=base.lastIndexOf(useUnishox||key?0:1)+1;
      base=base.slice(0,base.length-end<=7?end:base.length-7);
      if (allowInsertion) {
        base = [...magicNum1,...base,...magicNum2];//å¦‚æœå…ˆåŠ magic numå†åŠ å¯†ï¼Œé‚£ä¹ˆå°±è¦åœ¨æ¯ä¸ªä½ç½®éƒ½å¯»æ‰¾é•¿åº¦>=(67*8)çš„æ‰€æœ‰å­ä¸²ï¼Œæ­¤æ—¶å°¾æ’æ— å½±å“ï¼ˆå› ä¸ºæ˜¯æŒ‰é¡ºåºå’Œæœ€å°é•¿åº¦æ‰¾èµ·ï¼‰ï¼Œå¦‚æœå¤´æ’æ•°é‡ä¸ºn bitï¼Œåˆ™å¯»æ‰¾æ¬¡æ•°ä¸ºn(n+1)/2ï¼Œå³æ˜¯è¯´åªæœ‰å°‘é‡å¤´æ’çš„æƒ…å†µä¸‹æ‰èƒ½æˆåŠŸã€‚//todo:å½“ç”¨æˆ·é€‰ä¸­å…è®¸å¤´å°¾æ’å…¥æ—¶ï¼Œæ·»åŠ é€‰é¡¹"éšè”½çš„åŠ å¯†"ï¼šå½“ç»“åˆåŠ å¯†ä½¿ç”¨æ—¶ï¼Œé¿å…å¢åŠ éšå†™æš´éœ²çš„é£é™©ï¼Œä½†åªå…è®¸å¤´éƒ¨æ’å…¥å°‘é‡æ–‡æœ¬ã€‚è¿™éœ€æ±‚æˆ‘çœ‹äº†éƒ½æ„Ÿè§‰ç»·ä¸ä½ã€‚
      }
      console.log(base);//1å’Œ0çš„æ¯”ä¾‹å·®è·ä¸€èˆ¬ä¸è¶…è¿‡10%
      await fetch("http://127.0.0.1:8090/props")
        .then((res) => res.json())
        .then(async (json) => {
          if (json.chat_template.includes("</think>")) {
            // prompt+="<think>";//æ”¯æŒæ€è€ƒæ¨¡å¼
            // await fetch('http://127.0.0.1:8090/completion', {method: 'POST',
            //     body: JSON.stringify({prompt:prompt,stop:["</think>"]}),
            // }).then(res=>res.json()).then(json=>{
            //     if(json.stopping_word)
            //         prompt+=json.content;
            // });
            // prompt+="</think>\n\n";
            prompt += "<think>\n</think>\n\n";//å®æµ‹å‘½ä»¤è¡Œå…³é—­æ€è€ƒæ¨¡å¼ä¼šå¯¼è‡´æ•ˆæœé™ä½
          }
        });
      currentPrompt = await tokenize(prompt);
      currentCoverText = [];
      $('coverText').value = "";
      currentShuffle = 0;
      status = false;
      $('progress').value="0";
      $('progress').classList.remove("hidden");
      $('tooltip3').classList.remove("invisible");
      await dfs(0, "", 0, 0);
      $('tooltip3').classList.add("invisible");
      $('progress').classList.add("hidden");
      if (!status) modal(dynamicContent(`è¯·å°è¯•ä½¿ç”¨æ›´åŠ å‘æ•£çš„ä»»åŠ¡æç¤ºï¼Œæˆ–è°ƒæ•´å’Œå‡å°‘è¾“å…¥å†…å®¹`, `è«‹å˜—è©¦ä½¿ç”¨æ›´åŠ ç™¼æ•£çš„ä»»å‹™æç¤ºï¼Œæˆ–èª¿æ•´ä¸¦æ¸›å°‘è¼¸å…¥å…§å®¹`, `Please try using a more divergent task prompt, or adjust and reduce the input content`), dynamicContent(`éšå†™å¤±è´¥ï¼`, `éš±å¯«å¤±æ•—ï¼`, `Steganography failed!`));
    }
    async function extract(coverText) {
      if (!coverText) {
        $('coverText').focus();
        return;
      }
      let tcoverText = coverText;
      let findMagicNum=false;
      let base=[];
      for (; tcoverText; tcoverText = tcoverText.slice(1)) {
        let tstr = "",tscore = 0;base=[];
        for (const char of tcoverText) {
          tstr += char;
          tscore += getWeight(char.codePointAt(0));
          if (tscore >= 3) {
            base.push((await sha512Mod2(tstr)));
            tstr = "";
            tscore = 0;
          }
        }
        let index1 = findSublistIndex(base, magicNum1);
        if (index1 == -1) continue;
        // console.log(base)
        let index2 = findSublistIndex(base, magicNum2);
        if (index2 == -1) continue;
        if(index2<=index1+20)continue;
        base = base.slice(index1+20, index2);
        findMagicNum=true;
        // console.log(base);
        break;
      }
      if (!findMagicNum) {
        let tstr = "",tscore = 0;base=[];
        for (const char of coverText) {
          tstr += char;
          tscore += getWeight(char.codePointAt(0));
          if (tscore >= 3) {
            base.push((await sha512Mod2(tstr)));
            tstr = "";
            tscore = 0;
          }
        }
      }
      // console.log(base)// let useUnishox=base[0];base=base.slice(1);
      let key = await readTextFile($('privateKey'));
      if (key) {
        base = await eccDecryptToUint8Array(toBytes([...base, ...Array((8 - base.length % 8) % 8).fill(1)]), JSON.parse(key));
      }
      $('secret').value = await unishoxDecompress(base); // $('secret').value=await unishoxDecompress(data,useUnishox);
    }
    $('hide').onclick = async () => {
      await encrypt($('prompt').value, $('secret').value);
    };
    $('extract').onclick = async () => {
      await extract($('coverText').value);
    };
    //todo:æ‰¾åˆ°ä¸€ç§è¶³å¤Ÿé€šç”¨çš„system promptæ³¨å…¥æ–¹å¼
    //todo:å¯¹äºå®‰å“ï¼Œåªé’ˆå¯¹serveræ„å»ºï¼Œè€Œä¸æ˜¯å®Œå…¨æ„å»º
    //todo:unishox3ã€é«˜é¢‘è¯
    //todo:logit_biasã€tokenè¿‡æ»¤ã€é‡‡æ ·å‚æ•°è°ƒæ•´ç­‰æ–¹å¼æé«˜tokenè´¨é‡
    //todo:ç›®å‰çš„å°¾éƒ¨è¡¥å…¨çš„æœºåˆ¶è¿‡äºç®€é™‹ï¼Œä¹Ÿä¸ä¸€å®šé€‚åˆæ‰€æœ‰è¯­è¨€ï¼Œæ€»æœ‰ä¸€å¤©ä¼šå‡ºç°é—®é¢˜ã€‚
    //ä¸€ç§ç‰ºç‰²éšå†™å®¹é‡æé«˜é²æ£’æ€§å’Œéšå†™æ•ˆæœçš„æ–¹æ³•ï¼šéƒ¨åˆ†æˆªå–ç‰‡æ®µç›´æ¥ä½¿ç”¨ï¼Œä¸å°è¯•æ˜ å°„
    //æ˜¯å¦åº”è¯¥æ”¯æŒæ›´æ–°ï¼Ÿä¸è¿‡ç”±äºæ˜¯esmï¼Œå®ç°èµ·æ¥è¿˜æ˜¯å¾ˆéº»çƒ¦çš„
    // fetch('http://127.0.0.1:8090/props').then(res=>res.json()).then(json=>console.log(json));
  </script>
</Layout>