---
import Layout from '../layouts/Layout.astro';
---
<Layout title='StegLLM' >
    <div class="shadow p-4 flex justify-between items-center">
        <div class="flex-1 gap-2">
            <button class="btn btn-soft btn-accent btn-sm" id="import"></button>
            <button class="btn btn-soft btn-accent btn-sm" id="export"></button>
            <button class="btn btn-soft btn-warning btn-sm" id="generateKeyPair"></button>
        </div>
        <div class="flex gap-2 items-center">
            <a href="https://github.com/Rin313/StegLLM" target="_blank" class="p-2" id="github">
                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.332-1.754-1.332-1.754-1.09-.745.083-.73.083-.73 1.205.085 1.838 1.236 1.838 1.236 1.07 1.835 2.807 1.305 3.492.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12z"/></svg>
            </a>
            <div class="dropdown dropdown-center">
                <div tabindex="0" role="button" class="btn btn-ghost p-2" id="language">
                    <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2m6.93 6h-2.95a15.7 15.7 0 0 0-1.38-3.56A8.03 8.03 0 0 1 18.92 8M12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96M4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56A8 8 0 0 1 5.08 16m2.95-8H5.08a8 8 0 0 1 4.33-3.56A15.7 15.7 0 0 0 8.03 8M12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96M14.34 14H9.66c-.09-.66-.16-1.32-.16-2s.07-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2m.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2z"/></svg>
                </div>
                <ul tabindex="0" class="dropdown-content bg-base-200 z-1 py-1 w-20">
                    <li>
                        <input
                                type="radio"
                                name="language-dropdown"
                                class="btn btn-sm btn-block btn-ghost"
                                aria-label="ç®€ä½“ä¸­æ–‡"
                                value="simplifiedChinese" />
                    </li>
                    <li>
                        <input
                                type="radio"
                                name="language-dropdown"
                                class="btn btn-sm btn-block btn-ghost"
                                aria-label="æ­£é«”ä¸­æ–‡"
                                value="traditionalChinese" />
                    </li>
                    <li>
                        <input
                                type="radio"
                                name="language-dropdown"
                                class="btn btn-sm btn-block btn-ghost"
                                aria-label="English"
                                value="english" />
                    </li>
                </ul>
            </div>
            <div class="dropdown dropdown-center">
                <div tabindex="0" role="button" class="btn btn-ghost p-2" id="theme">
                    <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.04 10 9c0 3.31-2.69 6-6 6h-1.77c-.28 0-.5.22-.5.5c0 .12.05.23.13.33c.41.47.64 1.06.64 1.67A2.5 2.5 0 0 1 12 22m0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8c.28 0 .5-.22.5-.5a.54.54 0 0 0-.14-.35c-.41-.46-.63-1.05-.63-1.65a2.5 2.5 0 0 1 2.5-2.5H16c2.21 0 4-1.79 4-4c0-3.86-3.59-7-8-7"/><circle cx="6.5" cy="11.5" r="1.5" fill="currentColor"/><circle cx="9.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="14.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="17.5" cy="11.5" r="1.5" fill="currentColor"/></svg>
                </div>
                <ul tabindex="0" class="dropdown-content bg-base-200 z-1 py-1">
                    <li>
                        <input
                                type="radio"
                                name="theme-dropdown"
                                class="theme-controller btn btn-sm btn-block btn-ghost"
                                aria-label="ðŸŒ"
                                value="default" />
                    </li>
                    <li>
                        <input
                                type="radio"
                                name="theme-dropdown"
                                class="theme-controller btn btn-sm btn-block btn-ghost"
                                aria-label="ðŸŒš"
                                value="dark" />
                    </li>
                    <li>
                        <input
                                type="radio"
                                name="theme-dropdown"
                                class="theme-controller btn btn-sm btn-block btn-ghost"
                                aria-label="ðŸŒ¸"
                                value="valentine" />
                    </li>
                    <li>
                        <input
                                type="radio"
                                name="theme-dropdown"
                                class="theme-controller btn btn-sm btn-block btn-ghost"
                                aria-label="ðŸ“œ"
                                value="retro" />
                    </li>
                    <li>
                        <input
                                type="radio"
                                name="theme-dropdown"
                                class="theme-controller btn btn-sm btn-block btn-ghost"
                                aria-label="â˜•"
                                value="coffee" />
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="flex-grow py-6 container mx-auto max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6">
            <div class="shadow rounded-lg p-6 flex flex-col gap-6">
                <textarea class="textarea textarea-info w-full h-120 bg-base-200 rounded-lg resize-none" id="secret"></textarea>
                <fieldset class="fieldset">
                    <div class="tooltip" id="tooltip">
                        <legend class="fieldset-legend" id="publicKeyTitle"></legend>
                    </div>
                    <input type="file" class="file-input file-input-success" id="publicKey"/>
                </fieldset>
                <div class="tooltip" id="tooltip2">
                    <fieldset class="fieldset">
                        <label class="fieldset-label">
                            <input type="checkbox" class="toggle toggle-info" id="insertion"/>
                            <span id="insertionText"></span>
                        </label>
                    </fieldset>
                </div>
            </div>
            <div class="flex flex-col items-center justify-center gap-8">
                <div class="radial-progress text-primary hidden" style="--value:0;--size:4rem" aria-valuenow="0" role="progressbar" id="progress"></div>
                <div class="tooltip invisible" id="tooltip3">
                    <button class="btn btn-primary btn-circle btn-xl visible" id="hide">
                        <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M10.5 15h3l-.575-3.225q.5-.25.788-.725T14 10q0-.825-.587-1.412T12 8t-1.412.588T10 10q0 .575.288 1.05t.787.725zm1.5 7q-3.475-.875-5.738-3.988T4 11.1V5l8-3l8 3v6.1q0 3.8-2.262 6.913T12 22"/></svg>
                    </button>
                </div>
                <button class="btn btn-secondary btn-circle btn-xl" id="extract">
                    <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M18 1c-2.76 0-5 2.24-5 5v2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12c1.11 0 2-.89 2-2V10a2 2 0 0 0-2-2h-1V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2h2V6c0-2.76-2.24-5-5-5m-8 12a2 2 0 0 1 2 2c0 1.11-.89 2-2 2a2 2 0 1 1 0-4"/></svg>
                </button>
            </div>
            <div class="shadow rounded-lg p-6 flex flex-col gap-6">
                <textarea class="textarea textarea-info w-full h-120 bg-base-200 rounded-lg resize-none" id='coverText'></textarea>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend" id="privateKeyTitle"></legend>
                    <input type="file" class="file-input file-input-warning" id="privateKey"/>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="pl-6 mb-10 container mx-auto max-w-6xl">
        <div class="flex flex-row gap-4 items-center">
            <textarea class="textarea textarea-info w-full h-24 bg-base-200 rounded-lg resize-none" id='prompt'></textarea>
            <div class="flex flex-col">
                <button class="btn btn-ghost" id="up">â–²</button>
                <button class="btn btn-ghost" id="down">â–¼</button>
            </div>
            <button class="btn btn-ghost" id="save">
                <svg class="w-8 h-8" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3m3-10H5V5h10z"/></svg>
            </button>
        </div>
    </div>
    <script>
        import el,{setAllButtonTypesToButton,get,save,saveList,runIfMatch,generateKeyPair,exportLocalStorage,importLocalStorage,initDaisyThemeController,initLogitBias,unishoxCompress,readTextFile,eccEncryptToUint8Array,eccDecryptToUint8Array,shuffle,toBinary,toBytes,findSublistIndex,unishoxDecompress,tokenize,stringToUnicode} from '../utils/commonUtils';
        import xxhash from 'xxhash-wasm';//hash-wasmä¸æä¾›è¿”å›žintç±»åž‹çš„æŽ¥å£
        const { h32 } = await xxhash();
        function confirm(msg=null,title=null){
            if(title)el.confirmTitle.textContent=title;
            el.confirmMsg.textContent = msg;
            el.confirm.showModal();
        }
        function alert(msg=null,title=null){
            el.alertTitle.textContent=title;
            el.alertMsg.textContent=msg;
            el.alert.showModal();
        }
        setAllButtonTypesToButton();
        const themeButtons = document.querySelectorAll(`input[name="theme-dropdown"]`);
        function assignStrs(strs) {
            [
                el.import.textContent,
                el.export.textContent,
                el.generateKeyPair.textContent,
                el.publicKeyTitle.textContent,
                el.privateKeyTitle.textContent,
                el.publicKey.ariaLabel,
                el.privateKey.ariaLabel,
                el.secret.placeholder,
                el.coverText.placeholder,
                el.prompt.placeholder,
                el.ok.textContent,
                el.github.ariaLabel,
                el.language.ariaLabel,
                el.theme.ariaLabel,
                el.hide.ariaLabel,
                el.extract.ariaLabel,
                el.save.ariaLabel,
                el.progress.ariaLabel,
                el.insertionText.textContent
            ] = strs;
        }
        function setLanguage(){
            runIfMatch('language','simplifiedChinese',{
                simplifiedChinese:['å¯¼å…¥é…ç½®','å¯¼å‡ºé…ç½®','ç”Ÿæˆå¯†é’¥','è¾“å…¥æŽ¥æ”¶æ–¹çš„å…¬é’¥ï¼ˆå¯é€‰ï¼‰','è¾“å…¥ä½ çš„ç§é’¥ï¼ˆå¯é€‰ï¼‰','è¾“å…¥æŽ¥æ”¶æ–¹çš„å…¬é’¥ï¼ˆå¯é€‰ï¼‰','è¾“å…¥ä½ çš„ç§é’¥ï¼ˆå¯é€‰ï¼‰','è¯·è¾“å…¥éœ€è¦åŠ å¯†çš„ä¿¡æ¯','æ­¤å¤„æ˜¾ç¤ºç”Ÿæˆçš„æŽ©é¥°æ–‡æœ¬',`è¯·è¾“å…¥ä»»åŠ¡æç¤ºï¼Œä¾‹å¦‚ï¼š"ç»­å†™ä¸€æ®µæ•£æ–‡ï¼š"\nä½ å¯ä»¥é€šè¿‡å³ä¾§çš„ä¿å­˜æŒ‰é’®æ¥ä¿å­˜å½“å‰çš„æç¤ºæ¨¡æ¿`,'ç¡®å®š','Github','è¯­è¨€','ä¸»é¢˜','éšå†™','æå–','ä¿å­˜','è¿›åº¦æ¡','æ”¯æŒå‰åŽæ’å…¥'],
                traditionalChinese:['å°Žå…¥é…ç½®', 'å°Žå‡ºé…ç½®', 'ç”Ÿæˆå¯†é‘°', 'è¼¸å…¥æŽ¥æ”¶æ–¹çš„å…¬é‘°ï¼ˆå¯é¸ï¼‰', 'è¼¸å…¥ä½ çš„ç§é‘°ï¼ˆå¯é¸ï¼‰', 'è¼¸å…¥æŽ¥æ”¶æ–¹çš„å…¬é‘°ï¼ˆå¯é¸ï¼‰', 'è¼¸å…¥ä½ çš„ç§é‘°ï¼ˆå¯é¸ï¼‰', 'è«‹è¼¸å…¥éœ€è¦åŠ å¯†çš„ä¿¡æ¯', 'æ­¤è™•é¡¯ç¤ºç”Ÿæˆçš„æŽ©é£¾æ–‡æœ¬', `è«‹è¼¸å…¥ä»»å‹™æç¤ºï¼Œä¾‹å¦‚ï¼šã€ŒçºŒå¯«ä¸€æ®µæ•£æ–‡ï¼šã€\næ‚¨å¯ä»¥é€šéŽå³å´çš„å„²å­˜æŒ‰éˆ•ä¾†å„²å­˜ç•¶å‰çš„æç¤ºæ¨¡æ¿ã€‚`, 'ç¢ºå®š', 'Github', 'èªžè¨€', 'ä¸»é¡Œ', 'éš±å¯«', 'æå–', 'ä¿å­˜', 'é€²åº¦æ¢', 'æ”¯æŒå‰å¾Œæ’å…¥'],
                english:['Import Configuration', 'Export Configuration', 'Generate Key', 'Enter Recipient\'s Public Key (Optional)', 'Enter Your Private Key (Optional)', 'Enter Recipient\'s Public Key (Optional)', 'Enter Your Private Key (Optional)', 'Please Enter the Information to Encrypt', 'The Generated Masked Text is Displayed Here', `Please enter a task prompt, for example: "Continue writing a prose passage:"\nYou can save the current prompt template using the save button on the right.`, 'Confirm', 'Github', 'Language', 'Theme', 'Steganography', 'Extract', 'Save', 'Progress Bar', 'Support Front and Back Insertion'],
            },(strs)=>{
                assignStrs(strs);
            });
            el.tooltip.setAttribute("data-tip",dynamicContent('å³ä½¿éšå†™æš´éœ²ï¼Œä¹Ÿèƒ½ç¡®ä¿åŽŸå§‹ä¿¡æ¯ä¸ä¼šè¢«ç ´è§£','å³ä½¿éš±å¯«æš´éœ²ï¼Œä¹Ÿèƒ½ç¢ºä¿åŽŸå§‹ä¿¡æ¯ä¸æœƒè¢«ç ´è§£','Even if the Steganography is Exposed, It Ensures the Original Information Cannot Be Cracked'))
            el.tooltip2.setAttribute("data-tip",dynamicContent('ç”Ÿæˆçš„æŽ©é¥°æ–‡æœ¬åµŒå…¥åˆ°ä»»æ„æ–‡æœ¬åŽä»èƒ½å‡†ç¡®è§£å¯†ï¼Œç•¥å¾®å¢žåŠ éšå†™æš´éœ²çš„é£Žé™©','ç”Ÿæˆçš„æŽ©é£¾æ–‡æœ¬åµŒå…¥åˆ°ä»»æ„æ–‡æœ¬å¾Œä»èƒ½æº–ç¢ºè§£å¯†ï¼Œç•¥å¾®å¢žåŠ éš±å¯«æš´éœ²çš„é¢¨éšª','The generated cover text can still be accurately decrypted after being embedded into any text, slightly increasing the risk of steganographic exposure'))
            el.tooltip3.setAttribute("data-tip",dynamicContent('å†æ¬¡ç‚¹å‡»ä»¥åœæ­¢éšå†™','å†æ¬¡é»žæ“Šä»¥åœæ­¢éš±å¯«','Click again to stop steganography'));
        }
        function dynamicContent(...strs){
            return runIfMatch('language','simplifiedChinese',{
                simplifiedChinese:strs[0],traditionalChinese:strs[1],english:strs[2],
            },(value)=>{
                return value;
            })
        }
        function setTheme(){
            const theme=get('theme','default');
            for (const button of themeButtons) {
                if(button.value===theme){
                    button.checked=true;
                    return;
                }
            }
            save('theme','default');
        }
        function setInsertion(){
            el.insertion.checked=get('insertion',true);
        }
        setTheme();
        setLanguage();
        setInsertion();
        initDaisyThemeController();
        const languageButtons = document.querySelectorAll(`input[name="language-dropdown"]`);
        languageButtons.forEach(button => {
            button.addEventListener('change', function(event) {
                if (event.target.checked) {
                    save('language', event.target.value);
                    setLanguage();
                }
            });
        });
        el.insertion.addEventListener('change', function(event) {
            save('insertion',event.target.checked);
        })
        el.generateKeyPair.onclick=async ()=>{
            await generateKeyPair();
            alert(dynamicContent(`è¯·å®‰å…¨åœ°ä¿å­˜ä½ çš„ç§é’¥ï¼Œå¹¶æå‰å’ŒæŽ¥æ”¶æ–¹äº¤æ¢å…¬é’¥` ,`2`,`3`),dynamicContent('æˆåŠŸï¼','',''));
        }
        el.export.onclick=()=>{
            exportLocalStorage();
        }
        el.import.onclick=async ()=>{
            await importLocalStorage();
            setTheme();
            setLanguage();
        }
        let prompts=get('prompts',['']);let i=prompts.length-1;el.prompt.value=prompts[i];
        el.up.onclick=()=>{
            i=(i+1)%prompts.length;
            el.prompt.value=prompts[i];
        }
        el.down.onclick=()=>{
            i=(i-1+prompts.length)%prompts.length;
            el.prompt.value=prompts[i];
        }
        el.save.onclick=()=>{
            if(el.prompt.value){
                saveList('prompts',el.prompt.value);
                prompts=get('prompts',['']);i=prompts.length-1;
                alert('','ä¿å­˜æˆåŠŸï¼')
            }
            else{
                saveList('prompts',null,i);
                prompts=get('prompts',['']);i=prompts.length-1;el.prompt.value=prompts[i];
                alert('','åˆ é™¤æˆåŠŸï¼')
            }
        }
        function getWeight(code) {//scoreå€¼è¶Šå°ï¼Œå­—ç¬¦è¢«ä¿ç•™çš„æ¦‚çŽ‡è¶Šé«˜ã€‚
            //é›¶å®½å­—ç¬¦ï¼šçœ‹ä¼¼åœ¨éšå†™åœºæ™¯ä¸­è¦å°½å¯èƒ½ä¿ç•™ï¼Œä½†ä»Žç»Ÿè®¡ç‰¹å¾ä¸Šçœ‹ï¼Œè¿™äº›å­—ç¬¦å±žäºŽéžå¸¸å°‘è§çš„å­—ç¬¦ï¼Œä¸åº”è¯¥ä¸»åŠ¨æé«˜åˆ†å¸ƒçš„é¢‘çŽ‡ã€‚
            //ä¸€ä¸ªtokençº¦ä¸º1-1.8ä¸ªæ±‰å­—ï¼Œ0.75ä¸ªå•è¯æˆ–3-4ä¸ªå­—æ¯
            //å¿…é¡»è¦ä¿ç•™çš„å­—ç¬¦ï¼ˆéšæ„ä¸­æ–­å°†ä¸¥é‡ç ´åè¯­ä¹‰ï¼‰ï¼šå­—æ¯ã€æ™®é€šç©ºæ ¼ã€è‹±æ–‡é€—å·ã€è‹±æ–‡å¥å·
            //å°½é‡ä¿ç•™çš„å­—ç¬¦ï¼ˆå“ªæ€•ä¸ä¸­æ–­ä¹Ÿè¿˜æœ‰å¯èƒ½ç»­å†™ï¼‰ï¼šä¸­æ–‡é€—å·ã€ä¸­æ–‡å¥å·ã€ä¸­æ–‡å³å¼•å·ã€
            if (code===32||code===44||code===46||//æ™®é€šç©ºæ ¼ã€è‹±æ–‡é€—å·ã€è‹±æ–‡å¥å·
                (code >= 65 && code <= 90) ||  // å¤§å†™å­—æ¯ A-Z
                (code >= 97 && code <= 122))  // å°å†™å­—æ¯ a-z
                return 1;
            if(code===65292||code===12290||code===8221)//ä¸­æ–‡é€—å·ï¼Œä¸­æ–‡å¥å·ï¼Œä¸­æ–‡å³å¼•å·
                return 2;
            return 3;
        }// console.log(')'.codePointAt(0));
        const punctuations=["ï¼Ÿ","?","ï¼","!","ã€‚","ï¼‰",")","â€¦","}","]","."];//"\n"å’Œ"â€"æœ‰æ—¶å€™å¹¶ä¸ä»£è¡¨ç»“å°¾
        async function chat(str,progress,tailCompletion) {
            //let floor=7;//const probs=Math.round(25-Math.pow(progress, 0.1)*(25-floor));//éžçº¿æ€§tokenæ•°çš„å¯è¡Œæ€§ï¼štokenæ•°è¾ƒå¤šæ—¶ï¼Œå¦‚æžœrollåˆ°å¾ˆå·®çš„tokenï¼Œè¿™æ¬¡éšå†™å°±çƒ‚å®Œäº†ï¼›tokenè¾ƒå°‘æ—¶ï¼Œå¦‚æžœå¤±è´¥å›žæº¯ï¼Œä¸Šä¸€å±‚å‰©ä¸‹çš„å€™é€‰tokenè´¨é‡åªä¼šæ›´å·®ï¼›è¿˜ä¸å¦‚ä¸€å¼€å§‹å°±é€‰ä¸ªå›ºå®šçš„ç¨³å®šçš„å€¼
            let body={//åœ¨apiä¸­è®¾ç½®system_promptä¼šå¯¼è‡´æ€§èƒ½ä¸¥é‡ä¸‹é™
                // "stream": true,
                "n_predict": tailCompletion?-1:1,//ç”Ÿæˆçš„tokenæ•°ï¼Œ-1-2048
                // "temperature": 2.0,//å½±å“æ–‡æœ¬çš„éšæœºæ€§ï¼Œ0-2ï¼Œä½†æ˜¯ç›®å‰çš„é€‰è¯å®Œå…¨åŸºäºŽtop_k//todo:å¦‚æžœæ–°ç‰ˆçš„sampleré…ç½®å¯ç”¨ï¼Œå°è¯•å…³æŽ‰top_kä¹‹å¤–çš„é‡‡æ ·å™¨
                // "stop": punctuations,
                "repeat_last_n": 128,//é»˜è®¤64
                "repeat_penalty": 1.18,//é‡å¤æƒ©ç½šï¼Œ1.0ä¸ºæ— æƒ©ç½šï¼Œé»˜è®¤1.1ï¼Œå®žæµ‹å¶å°”ç¡®å®žä¼šå‡ºä¸å°‘é‡å¤
                // "top_p": 0.95,//é»˜è®¤0.95ï¼Œå¢žå¤§åŽä¼¼ä¹Žèƒ½å¢žåŠ æ›´å¤šçš„é€‰è¯å¯èƒ½æ€§
                // "min_p": 0.05,
                // "tfs_z": 1,//é»˜è®¤1.0ï¼Œç¦ç”¨
                // "typical_p": 1,//é»˜è®¤1.0ï¼Œç¦ç”¨
                // "presence_penalty": 0,
                // "frequency_penalty": 0,
                // "mirostat": 0,//å…³é—­mirostat
                // "mirostat_tau": 5,
                // "mirostat_eta": 0.1,
                // "grammar": "",
                // "min_keep": 10,
                // "image_data": [],
                // "post_sampling_probs":true,
                // "samplers": ["top_k"],//å“åº”ä¸Šçœ‹ä¼¼ä¹Žæ²¡æœ‰ä½¿ç”¨top_p,min_p,temperatureç­‰ï¼Ÿ
                "cache_prompt": true,//æç¤ºè¯å¤ç”¨
                // "api_key": "",
                "slot_id": 0,//é»˜è®¤-1ï¼Œåˆ†é…åˆ°ç©ºé—²æ’æ§½
                "prompt": str,//æ”¯æŒè¾“å…¥å¤šä¸ªprompt
                // "seed":-1,
                // "response_fields": ["content"],//ä¸ç”Ÿæ•ˆï¼Ÿ
                "logit_bias": tailCompletion?originLogitBias:logitBias//è¡¥å…¨ä¹Ÿç”¨logitBiasï¼Œå› ä¸ºèŽ·å–ä¸åˆ°tokenIdè¿˜åœ¨ç”¨h32ï¼Œæ‰€ä»¥å¦‚æžœæ˜¯é—®å·ï¼Œdetokenizeä¼šæŠ¥é”™
            }
            if(tailCompletion){
                body["stop"]=punctuations;//åŠ¨æ€æˆªæ–­
            }
            else if(currentShuffle===0){
                body["top_k"]= 24;//é€‰è¯èŒƒå›´ï¼Œé»˜è®¤40
                body["n_probs"]= 24;//æŒ‰æ¦‚çŽ‡æŽ’åºçš„å‰nä¸ªé€‰è¯ï¼Œå¦‚æžœtop_kä¸å¤Ÿå¥½åƒä¼šæ‹¿0å¼€å§‹çš„tokenè¡¥å…¨
            }
            else{
                body["top_k"]= 12;//ä¸€ä¸ªåˆé€‚çš„å€¼èƒ½å¤Ÿå¹³è¡¡å¥½æ˜ å°„å¤±è´¥æ¬¡æ•°å’Œæ–‡æœ¬è´¨é‡ï¼ŒåµŒå…¥ä¸€ä¸ªçŸ­å¥å‡ºçŽ°äºŒä¸‰åæ¬¡å¤±è´¥å…¶å®žè¿˜èƒ½æŽ¥å—ã€‚
                body["n_probs"]= 12;
            }
            const response = await fetch('http://127.0.0.1:8090/completion', {
                method: 'POST',
                body: JSON.stringify(body),
            });
            const json=(await response.json());//todo:ç›®å‰çš„jsonè§£æžé«˜è¾¾1-2ç§’ï¼Œæ€€ç–‘æ˜¯logitBiasè¿‡å¤§çš„ç¼˜æ•…ï¼Œå¾…APIå“ªå¤©æ›´æ–°åŽå†æµ‹ä¸€æ¬¡//const start = performance.now();//const end = performance.now();//console.log(end-start);
            if(tailCompletion){
                if(json.stopped_word)
                    return json.content+json.stopping_word;
                return chat(str,progress,true)
            }
            const t=json.completion_probabilities[0];
            if(!t)return [];//return chat(str,progress,false);//å½“é‡‡æ ·ç»“æžœæ˜¯ï¿½ï¼Œä¸ä¼šè¿”å›žé‡‡æ ·åˆ—è¡¨ï¼Œé—¹éº»äº†ï¼Œè€Œä¸”æœ‰å¯èƒ½å‘ç”Ÿæ— é™é‡‡æ ·ï¿½å¯¼è‡´å¡ä½
            if(currentShuffle<3||progress<=0.08){//è‡³å°‘shuffleä¸‰æ¬¡æ‰èƒ½ä¿è¯åŸºæœ¬çš„éšæœºæ€§//æ ¹æ®è¿›åº¦ç¡®å®šæ˜¯å¦shuffle
                currentShuffle++;
                return shuffle(t.probs);
            }
            return t.probs;
        }
        let base,currentPrompt,currentCoverText,currentShuffle,status,allowInsertion;
        async function dfs(i,tstr,tscore){if(status)return;
            const percents=i/base.length;
            const percent100=percents*100;
            el.progress.style.setProperty('--value',percent100);el.progress.setAttribute('aria-valuenow', percent100);
            const list=(await chat(currentPrompt+currentCoverText,percents,false));//æ•´ä¸ªdfsé™¤äº†chatï¼Œå‡ ä¹Žä¸è€—æ—¶é—´ï¼Œå› æ­¤å“ªæ€•æå‰å°è¯•ç¬¬äºŒæ¬¡è¯·æ±‚ä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„
            // if(list.length===0)return;//æµ‹è¯•æ˜ å°„å¤±è´¥æ¬¡æ•°æ—¶é¿å…å¹²æ‰°
            // for(let j=0;j<list.length;j++){
            //     const t=list[j].tok_str;
            //     const xxx=await tokenize(t);
            //     const xxxy=stringToUnicode(t);
            //     console.log(`"${t}" "${xxxy}" ${xxx}`)
            // }
            for(let j=0;j<list.length;j++){if(status)return;
                const t=list[j].tok_str;if(!t||t.includes("ï¿½"))continue;//TODOï¼šå¦‚æžœapiä¿®å¤å›žæ˜¾tokenå€¼ï¼Œå°±èƒ½å®žçŽ°ä¼ é€’tokenåºåˆ—æ¥é¿å…æ— æ³•è§£ç çš„tokenï¼Œåªè¦æŠŠä¸¤ä¸ªæ— æ³•è§£ç çš„tokenæ‹¼èµ·æ¥å°±èƒ½å½¢æˆä¸€æ¡æœ‰æ•ˆè·¯å¾„
                let ttstr=tstr,ttscore=tscore,sections=0;
                for(let k=0;;k++){if(status)return;
                    if(k>=t.length){
                        currentCoverText+=t;el.coverText.value=currentCoverText;
                        await dfs(i+sections,ttstr,ttscore);if(status)return;//åœ¨è¿™é‡Œreturné¿å…currentCoverTexté€å±‚å›žæº¯ä¸ºç©ºå­—ç¬¦ä¸²
                        currentCoverText=currentCoverText.slice(0,-t.length);break;//å‡å°‘dfsä¼ é€’çš„å†…å­˜å ç”¨
                    }
                    ttstr+=t[k];ttscore+=getWeight(t.codePointAt(k))
                    if(t.codePointAt(k) > 0xFFFF)
                        ttstr+=[++k];
                    if(ttscore>=3){
                        if(h32(ttstr)%2!==base[i+sections])
                            break;
                        sections++;ttstr='';ttscore=0;
                        if(i+sections===base.length){//t.length-(k+1)
                            status=true;
                            currentCoverText+=allowInsertion?t:t.slice(0,k+1);//å¦‚æžœä¸å¼€å¯allowInsertionï¼Œç”¨ä¸Štä¸€æ ·èƒ½ä½¿å°¾éƒ¨ç¨å¾®è‡ªç„¶ä¸€ç‚¹ã€‚
                        }
                    }
                }
            }
            // console.log('æµ‹è¯•æ˜ å°„å¤±è´¥æ¬¡æ•°')
        }
        let init=false,logitBias,originLogitBias=[
            ["Â ",false],["Â Â ",false],["Â Â Â ",false],["Â Â Â Â ",false],["Â Â Â Â Â ",false],["Â Â Â Â Â Â ",false],["Â Â Â Â Â Â Â ",false],["Â Â Â Â Â Â Â Â ",false]//ä¸é—´æ–­ç©ºæ ¼æ˜¯ç”¨äºŽç²¾ç¡®æŽ’ç‰ˆçš„ç¬¦å·ï¼Œæ­£å¸¸äººå‡ ä¹Žä¸å¯èƒ½æ‰‹åŠ¨ä½¿ç”¨
            ,[" \n",false],["  \n",false],[" \n\n",false],["  \n\n",false],
        ];
        // let logitBias=[["",false],["ã€€",false],[" ",false],["   ",false],["ï¼Ž",false],["ã€",false],["ã€‘",false],["ã€ˆ",false],["ã€‰",false],[" ã€",false],
        //     ["ã€Š",false],["ã€‹",false],//é¿å…å‡ºçŽ°ä¸€äº›æ²¡å¤´æ²¡å°¾çš„å¼•ç”¨æ–‡ç« 
        //     ["A",false],["B",false],["C",false],["D",false],//é¿å…ç»­å†™é€‰æ‹©é¢˜
        //     ["ã€‚ï¼ˆ",false],["ï¼ˆ",false],["ï¼‰",false],//æ‹¬å·å®¹æ˜“å¼•å¯¼AIç”Ÿæˆæ³¨é‡Šå’Œè¦æ±‚
        //     ["ï¼Œ\n\n",false],["ï¼›\n",false],["â€”\n\n",false],["-\n\n",false],["â€“\n\n",false],["--\n\n",false],[" â€”\n\n",false],//å‡å°‘ä¸€äº›æ ‡ç‚¹å¡«å……ï¼Œå¢žåŠ æ–‡å­—å¯†åº¦
        //     ["\n\n",-3.3],["ã€‚\n\n",-3.3],["ï¼š\n\n",-3.3],["ï¼\n\n",-3.3],["â€¦\n\n",-3.3],["â€¦â€¦\n\n",-3.3],["ï¼Ÿ\n\n",-3.3],["ï¼‰\n\n",-3.3],["ã€‘\n\n",-3.3],["â€\n\n",-3.3],["â€ã€‚\n\n",-3.3],["\n",-1.2],["ï¼Œ\n",-1.2],["ã€‚\n",-1.2],["ï¼š\n",-1.2],["â€\n",-1.2],[".\n",-1.2],["ï¼Ÿ\n",-1.2],["â€¦\n",-1.2]];
        const magicNum=[
            0, 0, 0, 0, 1, 1, 0, 1,
            1, 0, 0, 1, 0, 1, 1, 0,
            1, 1, 1, 0, 1, 1, 0, 0,
        ]
        async function encrypt(prompt,plainText) {
            if(!el.progress.classList.contains('hidden')){
                status=true;
                return;
            }
            if(!init){
                logitBias=await initLogitBias(originLogitBias,8090);
                init=true;
            }
            if(!plainText){
                el.secret.focus();
                return;
            }
            if(!prompt){
                el.prompt.focus();
                return;
            }
            const compressed = await unishoxCompress(plainText);
            let [data,useUnishox]=compressed;
            let key=await readTextFile(el.publicKey)
            if(key){
                data= await eccEncryptToUint8Array(data,JSON.parse(key));
            }
            //æ·»åŠ çº é”™ç çš„è¯ï¼Œè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ä¸åè°ƒçš„åœ°æ–¹ï¼Œå¹¶æ£€æµ‹æ˜¯å¦ä»ç„¶èƒ½è¿˜åŽŸã€‚æˆ‘è§‰å¾—è¿™ä¸ªæ–¹å‘èµ°åäº†ï¼Œæƒ³åŠžæ³•å¢žå¼ºAIçš„éšå†™æ•ˆæžœæ‰æ˜¯ä»¥åŽçš„æ–¹å‘ã€‚
            console.log(data);
            base=toBinary(data);//base=[useUnishox,...toBinary(data)];//å¤„ç†ä¸ºäºŒè¿›åˆ¶åºåˆ—ï¼Œåœ¨æ˜ å°„æ—¶ç²’åº¦æ›´ç»†ï¼Œä½†å»ºè®®æ¯æ¬¡åªæ˜ å°„1ä½ï¼Œå‡å°‘æ˜ å°„å¤±è´¥çŽ‡ã€‚
            allowInsertion=get('insertion',true);
            if(allowInsertion){
                if(data.length>65535){
                    alert('å†…å®¹è¿‡å¤šï¼Œè¯·å‡å°‘å†…å®¹æˆ–å…³é—­å‰åŽæ’å…¥é€‰é¡¹')
                    return;
                }
                let length=new Uint8Array(2);//å¦‚æžœå…ˆåŠ magic numå†åŠ å¯†ï¼Œé‚£ä¹ˆå°±è¦åœ¨æ¯ä¸ªä½ç½®éƒ½å¯»æ‰¾é•¿åº¦>=(67*8)çš„æ‰€æœ‰å­ä¸²ï¼Œæ­¤æ—¶å°¾æ’æ— å½±å“ï¼ˆå› ä¸ºæ˜¯æŒ‰é¡ºåºå’Œæœ€å°é•¿åº¦æ‰¾èµ·ï¼‰ï¼Œå¦‚æžœå¤´æ’æ•°é‡ä¸ºn bitï¼Œåˆ™å¯»æ‰¾æ¬¡æ•°ä¸ºn(n+1)/2ï¼Œå³æ˜¯è¯´åªæœ‰å°‘é‡å¤´æ’çš„æƒ…å†µä¸‹æ‰èƒ½æˆåŠŸã€‚//todo:å½“ç”¨æˆ·é€‰ä¸­å…è®¸å¤´å°¾æ’å…¥æ—¶ï¼Œæ·»åŠ é€‰é¡¹"éšè”½çš„åŠ å¯†"ï¼šå½“ç»“åˆåŠ å¯†ä½¿ç”¨æ—¶ï¼Œé¿å…å¢žåŠ éšå†™æš´éœ²çš„é£Žé™©ï¼Œä½†åªå…è®¸å¤´éƒ¨æ’å…¥å°‘é‡æ–‡æœ¬ã€‚è¿™éœ€æ±‚æˆ‘çœ‹äº†éƒ½æ„Ÿè§‰ç»·ä¸ä½ã€‚
                length[0]=data.length/256;length[1]=data.length%256;
                base=[...magicNum,...toBinary(length),...base];
            }
            console.log(base);
            currentPrompt=prompt;currentCoverText='';currentShuffle=0;status=false;el.progress.style.setProperty('--value', 0);el.progress.setAttribute('aria-valuenow', 0);el.progress.classList.remove('hidden');el.tooltip3.classList.remove('invisible')
            await dfs(0,'',0);
            el.tooltip3.classList.add('invisible');el.progress.classList.add('hidden');
            if(!status){
                alert('è¯·å°è¯•å‡å°‘è¾“å…¥å†…å®¹ï¼Œæˆ–åœ¨githubåé¦ˆ','éšå†™å¤±è´¥ï¼');
                return;
            }
            if(allowInsertion&&!punctuations.includes(coverText[coverText.length-1])){//å¦‚æžœä¸å¼€å¯allowInsertionï¼Œå°±æ²¡æ³•å¯¹æŽ©é¥°æ–‡æœ¬è¿›è¡Œå°¾éƒ¨è‡ªåŠ¨è¡¥å…¨ã€‚å¦‚æžœå¼€å¯allowInsertionï¼Œé€šå¸¸å¾ˆå°‘æœ‰enableTailAutocompleteè¿™ä¸ªé€‰é¡¹çš„éœ€æ±‚ã€‚
                currentCoverText+=(await chat(currentPrompt+currentCoverText,1,true));
            }
            el.coverText.value= currentCoverText;
        }
        async function extract(coverText) {
            if(coverText){
                let base = [],tstr='',tscore=0;
                for(const char of coverText){
                    tstr+=char;tscore+=getWeight(char.codePointAt(0));
                    if(tscore>=3){
                        base.push(h32(tstr)%2);
                        tstr='';tscore=0;
                    }
                }
                console.log(base)
                let index=findSublistIndex(base,magicNum);
                if(index!=-1){
                    index+=24;
                    let length=0;
                    for(let i=0;i<16;i++){
                        length+=base[index+i]*(1<<(15-i));
                    }
                    index+=16;
                    base=base.slice(index,index+length*8);
                }
                console.log(base)// let useUnishox=base[0];base=base.slice(1);
                let data=toBytes(base);
                let key=await readTextFile(el.privateKey)
                if(key){
                    data=await eccDecryptToUint8Array(data,JSON.parse(key));
                }
                el.secret.value=await unishoxDecompress(data);// el.secret.value=await unishoxDecompress(data,useUnishox);
            }
        }
        el.hide.onclick=async ()=>{
            await encrypt(el.prompt.value,el.secret.value);
            // let s=0;//è€—æ—¶æµ‹è¯•
            // for(let i=0;i<10;i++){
            //     const start = performance.now();
            //     await encrypt(el.prompt.value,el.secret.value);
            //     const end = performance.now();
            //     s+=end-start;
            // }
            // console.log(s/10);
            // let s=0;//éšå†™å®¹é‡
            // for(let i=0;i<10;i++){
            //     await encrypt(el.prompt.value,el.secret.value);
            //     s+=currentCoverText.length;
            // }
            // console.log(`${base.length} ${s/10} ${base.length/(s/10)}`);//æµ‹é‡éšå†™å®¹é‡
        }
        el.extract.onclick=()=>{
            extract(el.coverText.value);
        }
        // let cnm='';
        // for(let i=0;;i++){
        //   try{
        //     const response = await fetch('http://127.0.0.1:8090/detokenize', {
        //       method: 'POST',
        //       body: JSON.stringify({tokens: [i]}),
        //     });
        //     if(!response.ok)cnm+='['+i+',false],';
        //   }
        //   catch {
        //     break;
        //   }
        // }
        // console.log(cnm)
    </script>
</Layout>